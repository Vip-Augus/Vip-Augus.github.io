<!DOCTYPE html>

<html class="" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Spring," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Spring Transaction 事务的使用和实现原理">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring 源码学习(九) Transaction 事务">
<meta property="og:url" content="http://yoursite.com/2019/07/18/spring/2019-07-18-spring-analysis-note-9/index.html">
<meta property="og:site_name" content="JingQ">
<meta property="og:description" content="Spring Transaction 事务的使用和实现原理">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gitee.com/vip-augus/blog-picture/raw/master/Spring/spring9/Ushitukiiwa_ZH-CN5710944706_1920x1080.jpg">
<meta property="og:image" content="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/advisor_consist.png">
<meta property="og:image" content="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/infrastructrue_advisor_auto_proxy_creator_diagram.png">
<meta property="og:image" content="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/datasource_transaction_manager.png">
<meta property="og:updated_time" content="2021-10-30T17:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring 源码学习(九) Transaction 事务">
<meta name="twitter:description" content="Spring Transaction 事务的使用和实现原理">
<meta name="twitter:image" content="https://gitee.com/vip-augus/blog-picture/raw/master/Spring/spring9/Ushitukiiwa_ZH-CN5710944706_1920x1080.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'JingQ'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/18/spring/2019-07-18-spring-analysis-note-9/"/>





  <title>Spring 源码学习(九) Transaction 事务 | JingQ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JingQ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-javatech">
          <a href="http://www.justdojava.com/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java Geek Tech
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/spring/2019-07-18-spring-analysis-note-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JingQ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img.sevenyuan.cn/%E5%B0%8F%E7%86%8A%E7%8C%AB.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JingQ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring 源码学习(九) Transaction 事务</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-18T20:12:00+08:00">
                2019-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 游览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://gitee.com/vip-augus/blog-picture/raw/master/Spring/spring9/Ushitukiiwa_ZH-CN5710944706_1920x1080.jpg" alt=""></p>
<center> Spring Transaction 事务的使用和实现原理</center>

<a id="more"></a>
<hr>
<p>业务系统的数据，一般最后都会落入到数据库中，例如 <code>MySQL</code>、<code>Oracle</code> 等主流数据库，不可避免的，在数据更新时，有可能会遇到错误，这时需要将之前的数据更新操作撤回，避免错误数据。</p>
<p><strong><code>Spring</code> 的声明式事务能帮我们处理回滚操作，让我们不需要去关注数据库底层的事务操作，可以不用在出现异常情况下，在 try / catch / finaly 中手写回滚操作。</strong></p>
<p><strong><code>Spring</code> 的事务保证程度比行业中其它技术（例如 <code>TCC</code> / <code>2PC</code> / <code>3PC</code> 等）稍弱一些，但使用 <code>Spring</code> 事务已经满足大部分场景，所以它的使用和配置规则也是值得学习的。</strong></p>
<p>接下来一起学习 <code>Spring</code> 事务是如何使用以及实现原理吧。</p>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong>  <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener">DocToc</a></em></p>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90">使用例子</a></li>
<li><a href="#%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7-transactional">注解属性 @Transactional</a><ul>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E6%80%A7-propagation">事务的传播性 Propagation</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7-isolation">事务的隔离性 Isolation</a></li>
</ul>
</li>
<li><a href="#spring-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91">Spring 中实现逻辑</a><ul>
<li><a href="#%E8%A7%A3%E6%9E%90">解析</a><ul>
<li><a href="#%E6%B3%A8%E5%86%8C-infrastructureadvisorautoproxycreator">注册 InfrastructureAdvisorAutoProxyCreator</a><ul>
<li><a href="#%E5%88%A4%E6%96%AD%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%98%AF%E5%90%A6%E9%80%82%E5%90%88-canapply">判断目标方法是否适合 canApply</a></li>
<li><a href="#%E5%8C%B9%E9%85%8D%E6%A0%87%E7%AD%BE-match">匹配标签 match</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
<li><a href="#%E8%BF%90%E8%A1%8C">运行</a><ul>
<li><a href="#%E4%BA%8B%E5%8A%A1%E5%A2%9E%E5%BC%BA%E5%99%A8-transactioninterceptor">事务增强器 TransactionInterceptor</a><ul>
<li><a href="#%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8">事务管理器</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E5%BC%80%E5%90%AF">事务开启</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96-transactionstatus">获取 TransactionStatus</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96%E4%BA%8B%E5%8A%A1">获取事务</a></li>
</ul>
</li>
<li><a href="#%E5%A4%84%E7%90%86%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E7%9A%84%E4%BA%8B%E5%8A%A1">处理已经存在的事务</a><ul>
<li><a href="#propagation_never">PROPAGATION_NEVER</a></li>
<li><a href="#propagation_not_supported">PROPAGATION_NOT_SUPPORTED</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E6%8C%82%E8%B5%B7">事务挂起</a></li>
<li><a href="#propagation_requires_new">PROPAGATION_REQUIRES_NEW</a></li>
<li><a href="#propagation_nested">PROPAGATION_NESTED</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E5%88%9B%E5%BB%BA">事务创建</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93-1">小结</a></li>
<li><a href="#%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A--%E6%8F%90%E4%BA%A4">事务回滚 &amp; 提交</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<hr>
<h1 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h1><p>1.创建数据库表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> test.user(</div><div class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment	</div><div class="line">primary <span class="keyword">key</span>,</div><div class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="literal">null</span>, age <span class="built_in">int</span>(<span class="number">3</span>) <span class="literal">null</span>)</div><div class="line"><span class="keyword">engine</span>=<span class="keyword">InnoDB</span> <span class="keyword">charset</span>=utf8;</div></pre></td></tr></table></figure>
<p>2.创建对应数据库表的 PO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcUser</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Integer id;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Integer age;</div><div class="line">	</div><div class="line">	...(使用 ctrl + N 进行代码补全 setter 和 getter)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.创建表与实体间的映射</p>
<p><strong>在使用 <code>JdbcTemplate</code> 时很纠结，在 <code>Java</code> 类中写了很多硬编码 <code>SQL</code>，与 <code>MyBatis</code> 使用方法不一样，为了示例简单，使用了 <code>JdbcTemplate</code>，不过还是建议朋友们用 <code>MyBatis</code>，让代码风格整洁。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRowMapper</span> <span class="keyword">implements</span> <span class="title">RowMapper</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">		JdbcUser user = <span class="keyword">new</span> JdbcUser();</div><div class="line">		user.setId(rs.getInt(<span class="string">"id"</span>));</div><div class="line">		user.setName(rs.getString(<span class="string">"name"</span>));</div><div class="line">		user.setAge(rs.getInt(<span class="string">"age"</span>));</div><div class="line">		<span class="keyword">return</span> user;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.创建数据操作接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 插入</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> user	用户信息</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insertUser</span><span class="params">(JdbcUser user)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 根据 id 进行删除</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> id	主键</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 查询</span></div><div class="line"><span class="comment">	 * <span class="doctag">@return</span>	全部</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function">List&lt;JdbcUser&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.创建数据操作接口实现类</p>
<p>跟书中例子不一样，没有在接口上加入事务注解，而是在公共方法上进行添加，可以在每个方法上自定义传播事件、隔离级别。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserJdbcTemplate</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> DataSource dataSource;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUser</span><span class="params">(JdbcUser user)</span> </span>&#123;</div><div class="line">		String sql = <span class="string">"insert into user (id, name, age) values (?, ?, ?)"</span>;</div><div class="line">		jdbcTemplate.update(sql, user.getId(), user.getName(), user.getAge());</div><div class="line">		System.out.println(<span class="string">"Create record : "</span> + user.toString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="meta">@Transactional</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">		String sql = <span class="string">"delete from user where id = ?"</span>;</div><div class="line">		jdbcTemplate.update(sql, id);</div><div class="line">		System.out.println(<span class="string">"Delete record, id = "</span> + id);</div><div class="line">		<span class="comment">// 事务测试，抛出异常，让上面的插入操作回滚</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"aa"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;JdbcUser&gt; <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</div><div class="line">		String sql = <span class="string">"select * from user"</span>;</div><div class="line">		List&lt;JdbcUser&gt; users = jdbcTemplate.query(sql, <span class="keyword">new</span> UserRowMapper());</div><div class="line">		<span class="keyword">return</span> users;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</div><div class="line">		<span class="comment">// 使用 setter 注入参数时，同时初始化 jdbcTemplate</span></div><div class="line">		<span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">		<span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>6.创建配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">	   <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">	   <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></div><div class="line"><span class="tag">	   <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></div><div class="line"><span class="tag"><span class="string">	   http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></div><div class="line"><span class="tag"><span class="string">	   http://www.springframework.org/schema/tx</span></span></div><div class="line"><span class="tag"><span class="string">	   http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- 数据源 MySQL --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/test?characterEncoding=utf8"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"12345678"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userJdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"transaction.UserJdbcTemplate"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="comment">&lt;!-- 开启事务，如果将这行去掉，将不会创建事务  --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>7.添加依赖</p>
<p>记得添加数据库连接和 <code>jdbc</code>、<code>tx</code> 这两个 <code>spring</code> 模块的依赖</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">optional(<span class="keyword">project</span>(<span class="string">":spring-jdbc"</span>))  <span class="comment">// for Quartz support</span></div><div class="line">optional(<span class="keyword">project</span>(<span class="string">":spring-tx"</span>))  <span class="comment">// for Quartz support</span></div><div class="line"><span class="keyword">compile</span> <span class="keyword">group</span>: <span class="string">'mysql'</span>, name: <span class="string">'mysql-connector-java'</span>, version: <span class="string">'5.1.6'</span></div></pre></td></tr></table></figure>
<p> 8.启动代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionBootstrap</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">			ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"transaction/transaction.xml"</span>);</div><div class="line">			UserJdbcTemplate jdbcTemplate = (UserJdbcTemplate) context.getBean(<span class="string">"userJdbcTemplate"</span>);</div><div class="line">			System.out.println(<span class="string">"--- Records Creation start ----"</span>);</div><div class="line">			JdbcUser user = <span class="keyword">new</span> JdbcUser(<span class="number">4</span>, <span class="string">"test"</span>, <span class="number">21</span>);</div><div class="line">			jdbcTemplate.insertUser(user);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的代码，我做了两个测试：</p>
<ol>
<li><strong>配置文件中，没开启事务。</strong> 也就是 <code>&lt;tx:annotation-driven/&gt;</code> 这一行被注释了，虽然我们执行的方法中抛出了 <code>RuntimeExcepton</code>，但是数据库中依旧被插入了数据。</li>
<li><strong>配置文件中，开启事务。</strong> 将上面的注释去掉，删掉数据库中的记录，重新执行启动代码，发现数据没有被插入， 在程序抛出异常情况下，<code>Spring</code> 成功执行了事务，回滚了插入操作。</li>
</ol>
<hr>
<h1 id="注解属性-Transactional"><a href="#注解属性-Transactional" class="headerlink" title="注解属性 @Transactional"></a>注解属性 @Transactional</h1><p><strong>具体位置在：<code>org.springframework.transaction.annotation.Transactional</code></strong></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>String</td>
<td>可选的限定描述符，指定使用的事务管理器</td>
</tr>
<tr>
<td>propagation</td>
<td>枚举：Propagation</td>
<td>可选的事务传播行为</td>
</tr>
<tr>
<td>isolation</td>
<td>枚举：Isolation</td>
<td>可选的事务隔离级别设置</td>
</tr>
<tr>
<td>readOnly</td>
<td>boolean</td>
<td>设置读写或只读事务，默认是只读</td>
</tr>
<tr>
<td>rollbackFor</td>
<td>Class 数组，必须继承自 Throwable</td>
<td>导致事务回滚的异常类数组</td>
</tr>
<tr>
<td>rollbackForClassName</td>
<td>类名称数组，必须继承自 Throwable</td>
<td></td>
<td>导致事务回滚的异常类名字数组</td>
</tr>
<tr>
<td>noRollbackFor</td>
<td>Class 数组，必须继承自 Throwable</td>
<td>不会导致事务回滚的异常类数组</td>
</tr>
<tr>
<td>noRollbackForClassName</td>
<td>类名称数组，必须继承自 Throwable</td>
<td></td>
<td>不会导致事务回滚的异常类名字数组</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="事务的传播性-Propagation"><a href="#事务的传播性-Propagation" class="headerlink" title="事务的传播性 Propagation"></a>事务的传播性 Propagation</h2><ul>
<li><strong>REQUIRED</strong></li>
</ul>
<p>这是默认的传播属性，如果外部调用方有事务，将会加入到事务，没有的话新建一个。</p>
<ul>
<li><strong>PROPAGATION_SUPPORTS</strong></li>
</ul>
<p>如果当前存在事务，则加入到该事务；如果当前没有事务，则以非事务的方式继续运行。</p>
<ul>
<li><strong>PROPAGATION_NOT_SUPPORTED</strong></li>
</ul>
<p>以非事务方式运行，如果当前存在事务，则把当前事务挂起。</p>
<ul>
<li><strong>PROPAGATION_NEVER</strong></li>
</ul>
<p>以非事务方式运行，如果当前存在事务，则抛出异常。</p>
<hr>
<h2 id="事务的隔离性-Isolation"><a href="#事务的隔离性-Isolation" class="headerlink" title="事务的隔离性 Isolation"></a>事务的隔离性 Isolation</h2><ul>
<li><strong>READ_UNCOMMITTED</strong></li>
</ul>
<p>最低级别，只能保证不读取<br>物理上损害的数据，允许脏读</p>
<ul>
<li><strong>READ_COMMITTED</strong></li>
</ul>
<p>只能读到已经提交的数据</p>
<ul>
<li><strong>REPEATABLE_READ</strong></li>
</ul>
<p>可重复读</p>
<ul>
<li><strong>SERIALIZABLE</strong></li>
</ul>
<p>串行化读，读写相互阻塞</p>
<p><strong>这里只是简单描述了一下这两个主要属性，因为底层与数据库相关，可以看下我之前整理过的</strong> <a href="https://juejin.im/post/5ce8eee45188253114078f2a" target="_blank" rel="noopener">MySQL锁机制</a></p>
<hr>
<h1 id="Spring-中实现逻辑"><a href="#Spring-中实现逻辑" class="headerlink" title="Spring 中实现逻辑"></a>Spring 中实现逻辑</h1><p><strong>介绍完如何使用还有关键属性设定，本着知其然，知其所以然的学习精神，来了解代码是如何实现的吧。</strong></p>
<hr>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>之前在解析自定义标签时提到，<code>AOP</code> 和 <code>TX</code> 都使用了自定义标签，<strong>按照我们上一篇 <code>AOP</code> 的学习，再来一遍解析自定义标签的套路：事务自定义标签。</strong></p>
<p>定位到 <code>TxNamespaceHandler</code> 类的初始化方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	registerBeanDefinitionParser(<span class="string">"advice"</span>, <span class="keyword">new</span> TxAdviceBeanDefinitionParser());</div><div class="line">	<span class="comment">// 使用 AnnotationDrivenBeanDefinitionParser 解析器，解析 annotation-driven 标签</span></div><div class="line">	registerBeanDefinitionParser(<span class="string">"annotation-driven"</span>, <span class="keyword">new</span> AnnotationDrivenBeanDefinitionParser());</div><div class="line">	registerBeanDefinitionParser(<span class="string">"jta-transaction-manager"</span>, <span class="keyword">new</span> JtaTransactionManagerBeanDefinitionParser());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据上面的方法，<code>Spring</code> 在初始化时候，如果遇到诸如 <code>&lt;tx:annotation-driven&gt;</code> 开头的配置后，将会使用 <code>AnnotationDrivenBeanDefinitionParser</code> 解析器的 <code>parse</code> 方法进行解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">	registerTransactionalEventListenerFactory(parserContext);</div><div class="line">	String mode = element.getAttribute(<span class="string">"mode"</span>);</div><div class="line">	<span class="comment">// AspectJ 另外处理</span></div><div class="line">	<span class="keyword">if</span> (<span class="string">"aspectj"</span>.equals(mode)) &#123;</div><div class="line">		<span class="comment">// mode="aspectj"</span></div><div class="line">		registerTransactionAspect(element, parserContext);</div><div class="line">		<span class="keyword">if</span> (ClassUtils.isPresent(<span class="string">"javax.transaction.Transactional"</span>, getClass().getClassLoader())) &#123;</div><div class="line">			registerJtaTransactionAspect(element, parserContext);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// mode="proxy"</span></div><div class="line">		AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Spring</code> 中的事务默认是以 <code>AOP</code> 为基础，如果需要使用 <code>AspectJ</code> 的方式进行事务切入，需要在 <code>mode</code> 属性中配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">mode</span>=<span class="string">"aspectj"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>本篇笔记主要围绕着默认实现方式，动态 <code>AOP</code> 来学习，如果对于 <code>AspectJ</code> 实现感兴趣请查阅更多资料~</p>
<hr>
<h3 id="注册-InfrastructureAdvisorAutoProxyCreator"><a href="#注册-InfrastructureAdvisorAutoProxyCreator" class="headerlink" title="注册 InfrastructureAdvisorAutoProxyCreator"></a>注册 InfrastructureAdvisorAutoProxyCreator</h3><p>与 <code>AOP</code> 一样，在解析时，会创建一个自动创建代理器，在事务 <code>TX</code> 模块中，使用的是 <code>InfrastructureAdvisorAutoProxyCreator</code>。</p>
<p>首先来看，在默认配置情况下，<code>AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext)</code> 做了什么操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AopAutoProxyConfigurer</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">configureAutoProxyCreator</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">		<span class="comment">// 注册 InfrastructureAdvisorAutoProxyCreator 自动创建代理器</span></div><div class="line">		AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element);</div><div class="line">		<span class="comment">// txAdvisorBeanName = org.springframework.transaction.config.internalTransactionAdvisor</span></div><div class="line">		String txAdvisorBeanName = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME;</div><div class="line">		<span class="keyword">if</span> (!parserContext.getRegistry().containsBeanDefinition(txAdvisorBeanName)) &#123;</div><div class="line">			Object eleSource = parserContext.extractSource(element);</div><div class="line">			<span class="comment">// Create the TransactionAttributeSource definition.</span></div><div class="line">			<span class="comment">// 创建 TransactionAttributeSource 的 bean</span></div><div class="line">			RootBeanDefinition sourceDef = <span class="keyword">new</span> RootBeanDefinition(</div><div class="line">					<span class="string">"org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"</span>);</div><div class="line">			<span class="comment">// 注册 bean，并使用 Spring 中的定义规则生成 beanName</span></div><div class="line">			String sourceName = parserContext.getReaderContext().registerWithGeneratedName(sourceDef);</div><div class="line">			<span class="comment">// 创建 TransactionInterceptor 的 bean</span></div><div class="line">			RootBeanDefinition interceptorDef = <span class="keyword">new</span> RootBeanDefinition(TransactionInterceptor.class);</div><div class="line">			interceptorDef.getPropertyValues().add(<span class="string">"transactionAttributeSource"</span>, <span class="keyword">new</span> RuntimeBeanReference(sourceName));</div><div class="line">			String interceptorName = parserContext.getReaderContext().registerWithGeneratedName(interceptorDef);</div><div class="line">			<span class="comment">// 创建 TransactionAttributeSourceAdvisor 的 bean</span></div><div class="line">			RootBeanDefinition advisorDef = <span class="keyword">new</span> RootBeanDefinition(BeanFactoryTransactionAttributeSourceAdvisor.class);</div><div class="line">			<span class="comment">// 将 sourceName 的 bean 注入 advisor 的 transactionAttributeSource 属性中</span></div><div class="line">			advisorDef.getPropertyValues().add(<span class="string">"transactionAttributeSource"</span>, <span class="keyword">new</span> RuntimeBeanReference(sourceName));</div><div class="line">			<span class="comment">// 将 interceptorName 的 bean 注入到 advisor 的 adviceBeanName 属性中</span></div><div class="line">			advisorDef.getPropertyValues().add(<span class="string">"adviceBeanName"</span>, interceptorName);</div><div class="line">			<span class="keyword">if</span> (element.hasAttribute(<span class="string">"order"</span>)) &#123;</div><div class="line">				<span class="comment">// 如果配置了 order 属性，则加入到 bean 中</span></div><div class="line">				advisorDef.getPropertyValues().add(<span class="string">"order"</span>, element.getAttribute(<span class="string">"order"</span>));</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 以 txAdvisorBeanName 名字注册 advisorDef</span></div><div class="line">			parserContext.getRegistry().registerBeanDefinition(txAdvisorBeanName, advisorDef);</div><div class="line">			<span class="comment">// 创建 CompositeComponentDefinition</span></div><div class="line">			CompositeComponentDefinition compositeDef = <span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), eleSource);</div><div class="line">			compositeDef.addNestedComponent(<span class="keyword">new</span> BeanComponentDefinition(sourceDef, sourceName));</div><div class="line">			compositeDef.addNestedComponent(<span class="keyword">new</span> BeanComponentDefinition(interceptorDef, interceptorName));</div><div class="line">			compositeDef.addNestedComponent(<span class="keyword">new</span> BeanComponentDefinition(advisorDef, txAdvisorBeanName));</div><div class="line">			parserContext.registerComponent(compositeDef);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在这里注册了代理类和三个 <code>bean</code>，这三个关键 <code>bean</code> 支撑了整个事务功能，为了待会更好的理解这三者的关联关系，我们先来回顾下 <code>AOP</code> 的核心概念：</strong></p>
<ol>
<li><strong>Pointcut</strong><br>定义一个切点，可以在这个被拦截的方法前后进行切面逻辑。</li>
<li><strong>Advice</strong><br>用来定义拦截行为，在这里实现增强的逻辑，它是一个祖先接口 <code>org.aopalliance.aop.Advice</code>。还有其它继承接口，例如 <code>MethodBeforeAdvice</code> ，特定指方法执行前的增强。</li>
<li><strong>Advisor</strong><br>用来封装切面的所有信息，主要是上面两个，它用来充当 <code>Advice</code> 和 <code>Pointcut</code> 的适配器。</li>
</ol>
<p><img src="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/advisor_consist.png" alt="advisor_consist"></p>
<p>回顾完 <code>AOP</code> 的概念后，继续来看下这三个关键 <code>bean</code>:</p>
<ul>
<li><strong>TransactionInterceptor</strong>: 实现了 <code>Advice</code> 接口，在这里定义了拦截行为。</li>
<li><strong>AnnotationTransactionAttributeSource</strong>：封装了目标方法是否被拦截的逻辑，虽然没有实现 <code>Pointcut</code> 接口，但是在后面目标方法判断的时候，实际上还是委托给了 <code>AnnotationTransactionAttributeSource.getTransactionAttributeSource</code>，通过适配器模式，返回了 <code>Pointcut</code> 切点信息。</li>
<li><strong>TransactionAttributeSourceAdvisor</strong>: 实现了 <code>Advisor</code> 接口，包装了上面两个信息。</li>
</ul>
<p><strong>这三个 <code>bean</code> 组成的结构与 <code>AOP</code> 切面环绕实现的结构一致，所以先学习 <code>AOP</code> 的实现，对事务的了解会有所帮助</strong></p>
<hr>
<p>接着看我们的自动创建代理器是如何创建的：</p>
<blockquote>
<p>AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAutoProxyCreatorIfNecessary</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">		ParserContext parserContext, Element sourceElement)</span> </span>&#123;</div><div class="line">	BeanDefinition beanDefinition = AopConfigUtils.registerAutoProxyCreatorIfNecessary(</div><div class="line">			parserContext.getRegistry(), parserContext.extractSource(sourceElement));</div><div class="line">	useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</div><div class="line">	registerComponentIfNecessary(beanDefinition, parserContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerComponentIfNecessary</span><span class="params">(@Nullable BeanDefinition beanDefinition, ParserContext parserContext)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">	    <span class="comment">// 注册的 beanName 是 org.springframework.aop.config.internalAutoProxyCreator</span></div><div class="line">		parserContext.registerComponent(</div><div class="line">				<span class="keyword">new</span> BeanComponentDefinition(beanDefinition, AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在这一步中，注册了一个 <code>beanName</code> 是 <code>org.springframework.aop.config.internalAutoProxyCreator</code> 的 <code>bean</code>：<code>InfrastructureAdsivorAutoProxyCreator</code>，下图是它的继承体系图：</strong></p>
<p><img src="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/infrastructrue_advisor_auto_proxy_creator_diagram.png" alt="infrastructrue_advisor_auto_proxy_creator_diagram"></p>
<p><strong>可以看到，它实现了 <code>InstantiationAwareBeanPostProcessor</code> 这个接口，也就是说在 <code>Spring</code> 容器中，所有 <code>bean</code> 实例化时，<code>Spring</code> 都会保证调用其 <code>postProcessAfterInitialization</code> 方法。</strong></p>
<p>与上一篇介绍的 <code>AOP</code> 代理器一样，在实例化 <code>bean</code> 的时候，调用了代理器父类 <code>AbstractAutoProxyCreator</code> 的 <code>postProcessAfterInitialization</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(@Nullable Object bean, String beanName)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 组装 key</span></div><div class="line">		Object cacheKey = getCacheKey(bean.getClass(), beanName);</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;</div><div class="line">			<span class="comment">// 如果适合被代理，则需要封装指定的 bean</span></div><div class="line">			<span class="keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> bean;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中关于 <code>wrapIfNecessory</code> 方法，在上一篇 <code>AOP</code> 中已经详细讲过，这里讲下这个方法做了什么工作：</p>
<ol>
<li><strong>找出指定 <code>bean</code> 对应的增强器</strong></li>
<li><strong>根据找出的增强器创建代理</strong></li>
</ol>
<p>与创建 <code>AOP</code> 代理相似的过程就不再重复说，讲下它们的不同点：</p>
<hr>
<h4 id="判断目标方法是否适合-canApply"><a href="#判断目标方法是否适合-canApply" class="headerlink" title="判断目标方法是否适合 canApply"></a>判断目标方法是否适合 canApply</h4><blockquote>
<p>AopUtils#canApply(Advisor, Class&lt;?&gt;, boolean)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canApply</span><span class="params">(Advisor advisor, Class&lt;?&gt; targetClass, <span class="keyword">boolean</span> hasIntroductions)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (advisor <span class="keyword">instanceof</span> IntroductionAdvisor) &#123;</div><div class="line">		<span class="keyword">return</span> ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (advisor <span class="keyword">instanceof</span> PointcutAdvisor) &#123;</div><div class="line">		PointcutAdvisor pca = (PointcutAdvisor) advisor;</div><div class="line">		<span class="keyword">return</span> canApply(pca.getPointcut(), targetClass, hasIntroductions);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// It doesn't have a pointcut so we assume it applies.</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>我们在前面看到，<code>TransactionAttributeSourceAdvisor</code> 的父类是 <code>PointcutAdvisor</code>，所以在目标方法判断的时候，会取出切点信息 <code>pca.getPointcut()</code>。</strong></p>
<p><strong>我们之前注入的切面类型 <code>bean</code> 是 <code>AnnotationTransactionAttributeSource</code>，通过下面的方法包装，最后返回对象类型是 <code>TransactionAttributeSourcePointcut</code> 的切点信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransactionAttributeSourcePointcut pointcut = <span class="keyword">new</span> TransactionAttributeSourcePointcut() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="meta">@Nullable</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> TransactionAttributeSource <span class="title">getTransactionAttributeSource</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 实现父类的方法，在子类中进行了扩展，返回之前在标签注册时的AnnotationTransactionAttributeSource</span></div><div class="line">		<span class="keyword">return</span> transactionAttributeSource;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<h4 id="匹配标签-match"><a href="#匹配标签-match" class="headerlink" title="匹配标签 match"></a>匹配标签 match</h4><p><strong>在匹配 <code>match</code> 操作中，区别的是 <code>AOP</code> 识别的是 <code>@Before</code> 、<code>@After</code>，而我们的事务 <code>TX</code> 识别的是 <code>@Transactional</code> 标签。</strong></p>
<p>判断是否是事务方法的入口方法在这：</p>
<blockquote>
<p>org.springframework.transaction.interceptor.TransactionAttributeSourcePointcut#matches</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method, Class&lt;?&gt; targetClass)</span> </span>&#123;</div><div class="line">	<span class="comment">// 事务切点匹配的方法</span></div><div class="line">	TransactionAttributeSource tas = getTransactionAttributeSource();</div><div class="line">	<span class="keyword">return</span> (tas == <span class="keyword">null</span> || tas.getTransactionAttribute(method, targetClass) != <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那它到底到哪一步解析事务注解的呢，继续跟踪代码，答案是：</p>
<blockquote>
<p>AnnotationTransactionAttributeSource#determineTransactionAttribute</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> TransactionAttribute <span class="title">determineTransactionAttribute</span><span class="params">(AnnotatedElement element)</span> </span>&#123;</div><div class="line">	<span class="keyword">for</span> (TransactionAnnotationParser parser : <span class="keyword">this</span>.annotationParsers) &#123;</div><div class="line">		TransactionAttribute attr = parser.parseTransactionAnnotation(element);</div><div class="line">		<span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> attr;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这一步中，遍历注册的注解解析器进行解析，由于我们关注的是事务解析，所以直接定位到事务注解的解析器：</p>
<blockquote>
<p>SpringTransactionAnnotationParser#parseTransactionAnnotation(AnnotatedElement)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> TransactionAttribute <span class="title">parseTransactionAnnotation</span><span class="params">(AnnotatedElement element)</span> </span>&#123;</div><div class="line">	<span class="comment">// 解析事务注解的属性</span></div><div class="line">	AnnotationAttributes attributes = AnnotatedElementUtils.findMergedAnnotationAttributes(</div><div class="line">			element, Transactional.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">	<span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> parseTransactionAnnotation(attributes);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先判断是否含有 <code>@Transactional</code> 注解，如果有的话，才继续调用 <code>parse</code> 解析方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> TransactionAttribute <span class="title">parseTransactionAnnotation</span><span class="params">(AnnotationAttributes attributes)</span> </span>&#123;</div><div class="line">	RuleBasedTransactionAttribute rbta = <span class="keyword">new</span> RuleBasedTransactionAttribute();</div><div class="line">	<span class="comment">// 注释 9.4 解析事务注解的每一个属性</span></div><div class="line">	Propagation propagation = attributes.getEnum(<span class="string">"propagation"</span>);</div><div class="line">	rbta.setPropagationBehavior(propagation.value());</div><div class="line">	Isolation isolation = attributes.getEnum(<span class="string">"isolation"</span>);</div><div class="line">	rbta.setIsolationLevel(isolation.value());</div><div class="line">	rbta.setTimeout(attributes.getNumber(<span class="string">"timeout"</span>).intValue());</div><div class="line">	rbta.setReadOnly(attributes.getBoolean(<span class="string">"readOnly"</span>));</div><div class="line">	rbta.setQualifier(attributes.getString(<span class="string">"value"</span>));</div><div class="line">	List&lt;RollbackRuleAttribute&gt; rollbackRules = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">	<span class="keyword">for</span> (Class&lt;?&gt; rbRule : attributes.getClassArray(<span class="string">"rollbackFor"</span>)) &#123;</div><div class="line">		rollbackRules.add(<span class="keyword">new</span> RollbackRuleAttribute(rbRule));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (String rbRule : attributes.getStringArray(<span class="string">"rollbackForClassName"</span>)) &#123;</div><div class="line">		rollbackRules.add(<span class="keyword">new</span> RollbackRuleAttribute(rbRule));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (Class&lt;?&gt; rbRule : attributes.getClassArray(<span class="string">"noRollbackFor"</span>)) &#123;</div><div class="line">		rollbackRules.add(<span class="keyword">new</span> NoRollbackRuleAttribute(rbRule));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (String rbRule : attributes.getStringArray(<span class="string">"noRollbackForClassName"</span>)) &#123;</div><div class="line">		rollbackRules.add(<span class="keyword">new</span> NoRollbackRuleAttribute(rbRule));</div><div class="line">	&#125;</div><div class="line">	rbta.setRollbackRules(rollbackRules);</div><div class="line">	<span class="keyword">return</span> rbta;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>通过上面的步骤，完成了对应类或者方法的事务属性解析。</p>
<p>主要步骤在于寻找增强器，以及判断这些增强器是否与方法或者类匹配。</p>
<p>如果某个 <code>bean</code> 属于可被事务增强时，也就是适用于增强器 <code>BeanFactoryTransactionAttributeSourceAdvisor</code> 进行增强。</p>
<p><strong>之前我们注入了 <code>TransactionInterceptor</code> 到 <code>BeanFactoryTransactionAttributeSourceAdvisor</code> 中，所以在调用事务增强器增强的代理类时，会执行 <code>TransactionInterceptor</code> 进行增强。同时，也就是在 <code>TransactionInterceptor</code> 类中的 <code>invoke</code> 方法中完成整个事务的逻辑。</strong></p>
<hr>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><hr>
<h3 id="事务增强器-TransactionInterceptor"><a href="#事务增强器-TransactionInterceptor" class="headerlink" title="事务增强器 TransactionInterceptor"></a>事务增强器 TransactionInterceptor</h3><p><code>TransactionInterceptor</code> 支撑着整个事务功能的架构。跟之前 <code>AOP</code> 的 <code>JDK</code> 动态代理 分析的一样，<code>TransactionInterceptor</code> 拦截器继承于 <code>MethodInterceptor</code>，所以我们要从它的关键方法 <code>invoke()</code> 看起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">	<span class="comment">// 注释 9.5 执行事务拦截器，完成整个事务的逻辑</span></div><div class="line">	Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="keyword">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// Adapt to TransactionAspectSupport's invokeWithinTransaction...</span></div><div class="line">	<span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>实际调用了父类的方法：<code>TransactionAspectSupport#invokeWithinTransaction</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">invokeWithinTransaction</span><span class="params">(Method method, @Nullable Class&lt;?&gt; targetClass,</span></span></div><div class="line"><span class="function"><span class="params">		<span class="keyword">final</span> InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">	<span class="comment">// 如果transaction属性为null，则该方法是非事务性的</span></div><div class="line">	TransactionAttributeSource tas = getTransactionAttributeSource();</div><div class="line">	<span class="comment">// 获取对应事务属性</span></div><div class="line">	<span class="keyword">final</span> TransactionAttribute txAttr = (tas != <span class="keyword">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="keyword">null</span>);</div><div class="line">	<span class="comment">// 获取事务管理器</span></div><div class="line">	<span class="keyword">final</span> PlatformTransactionManager tm = determineTransactionManager(txAttr);</div><div class="line">	<span class="comment">// 构造方法唯一标识（类.方法）</span></div><div class="line">	<span class="keyword">final</span> String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</div><div class="line">	<span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || !(tm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;</div><div class="line">		<span class="comment">// 声明式事务处理</span></div><div class="line">		<span class="comment">// 标准事务划分 : 使用 getTransaction 和 commit / rollback 调用</span></div><div class="line">		TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</div><div class="line">		Object retVal;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//传入的是回调函数对象： invocation.proceed。 执行被增强的方法</span></div><div class="line">			retVal = invocation.proceedWithInvocation();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">			<span class="comment">// 异常回滚</span></div><div class="line">			completeTransactionAfterThrowing(txInfo, ex);</div><div class="line">			<span class="keyword">throw</span> ex;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">finally</span> &#123;</div><div class="line">			<span class="comment">// 清除信息</span></div><div class="line">			cleanupTransactionInfo(txInfo);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 提交事务</span></div><div class="line">		commitTransactionAfterReturning(txInfo);</div><div class="line">		<span class="keyword">return</span> retVal;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// 编程式事务处理</span></div><div class="line">		<span class="keyword">final</span> ThrowableHolder throwableHolder = <span class="keyword">new</span> ThrowableHolder();</div><div class="line">		<span class="comment">// It's a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Object result = ((CallbackPreferringPlatformTransactionManager) tm).execute(txAttr, status -&gt; &#123;</div><div class="line">				TransactionInfo txInfo = prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</div><div class="line">			...</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>贴出的代码有删减，简略了错误异常的 <code>try / catch</code> 和编程式事务处理的逻辑。<strong>因为我们更多使用到的是声明式事务处理，就是在 <code>XML</code> 文件配置或者 <code>@Transactional</code> 注解编码，实际通过 <code>AOP</code> 实现，而编程式事务处理是通过 <code>Transaction Template</code> 实现，比较少使用到，所以省略了这部分处理代码。</strong></p>
<hr>
<h4 id="事务管理器"><a href="#事务管理器" class="headerlink" title="事务管理器"></a>事务管理器</h4><p>通过该方法，确定要用于给定事务的特定事务管理器</p>
<blockquote>
<p>TransactionAspectSupport#determineTransactionManager</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> PlatformTransactionManager <span class="title">determineTransactionManager</span><span class="params">(@Nullable TransactionAttribute txAttr)</span> </span>&#123;</div><div class="line">	<span class="comment">// Do not attempt to lookup tx manager if no tx attributes are set</span></div><div class="line">	<span class="comment">// 注释 9.6 寻找事务管理器</span></div><div class="line">	<span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || <span class="keyword">this</span>.beanFactory == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">// 如果没有事务属性或者 BeanFactory 为空时，从缓存里面寻找</span></div><div class="line">		<span class="keyword">return</span> asPlatformTransactionManager(getTransactionManager());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	String qualifier = txAttr.getQualifier();</div><div class="line">	<span class="comment">// 如果注解配置中指定了事务管理器，直接取出使用</span></div><div class="line">	<span class="keyword">if</span> (StringUtils.hasText(qualifier)) &#123;</div><div class="line">		<span class="keyword">return</span> determineQualifiedTransactionManager(<span class="keyword">this</span>.beanFactory, qualifier);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.transactionManagerBeanName)) &#123;</div><div class="line">		<span class="keyword">return</span> determineQualifiedTransactionManager(<span class="keyword">this</span>.beanFactory, <span class="keyword">this</span>.transactionManagerBeanName);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// 上面步骤都没找到，最后才去容器中，根据 className 来寻找</span></div><div class="line">		PlatformTransactionManager defaultTransactionManager = asPlatformTransactionManager(getTransactionManager());</div><div class="line">		...</div><div class="line">		<span class="keyword">return</span> defaultTransactionManager;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于最开始我们在 <code>XML</code> 文件中配置过 <code>transactionManager</code> 属性，所以该方法在我们例子中将会返回类型是 <code>DataSourceTransactionManager</code> 的事务管理器，下面是 <code>DataSourceTransactionManager</code> 的继承体系：</p>
<p><img src="http://www.justdojava.com/assets/images/2019/java/image_yjq/Spring/spring9/datasource_transaction_manager.png" alt="datasource_transaction_manager"></p>
<p>它实现了 <code>InitializingBean</code> 接口，不过只是在 <code>afterPropertiesSet()</code> 方法中，简单校验 <code>dataSource</code> 是否为空，不细说这个类。</p>
<hr>
<h4 id="事务开启"><a href="#事务开启" class="headerlink" title="事务开启"></a>事务开启</h4><blockquote>
<p>TransactionAspectSupport#createTransactionIfNecessary</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">createTransactionIfNecessary</span><span class="params">(PlatformTransactionManager tm, TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果没有名称指定则使用方法唯一标识，并使用 DelegatingTransactionAttribute 包装 txAttr</span></div><div class="line">	<span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; txAttr.getName() == <span class="keyword">null</span>) &#123;</div><div class="line">		txAttr = <span class="keyword">new</span> DelegatingTransactionAttribute(txAttr) &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> joinpointIdentification;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	TransactionStatus status = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (tm != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 获取 TransactionStatus</span></div><div class="line">			status = tm.getTransaction(txAttr);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 根据指定的属性与 status 准备一个 TransactionInfo</span></div><div class="line">	<span class="keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在创建事务方法中，主要完成以下三件事：</p>
<ol>
<li><strong>使用 <code>DelegatingTransactionAttribute</code> 包装 <code>txAttr</code> 实例</strong></li>
<li><strong>获取事务：<code>tm.getTransaction(txAttr)</code></strong></li>
<li><strong>构建事务信息：<code>prepareTransactionInfo(tm, txAttr, joinpointIdentification, status)</code></strong></li>
</ol>
<p>核心方法在第二点和第三点，分别摘取核心进行熟悉。</p>
<hr>
<h4 id="获取-TransactionStatus"><a href="#获取-TransactionStatus" class="headerlink" title="获取 TransactionStatus"></a>获取 TransactionStatus</h4><blockquote>
<p>status = tm.getTransaction(txAttr);</p>
</blockquote>
<p>由于代码较长，直接来总结其中几个关键点</p>
<h5 id="获取事务"><a href="#获取事务" class="headerlink" title="获取事务"></a>获取事务</h5><p>创建对应的事务实例，我们使用的是 <code>DataSourceTransactionManager</code> 中的 <code>doGetTransaction</code> 方法，创建基于 <code>JDBC</code> 的事务实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doGetTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">	DataSourceTransactionObject txObject = <span class="keyword">new</span> DataSourceTransactionObject();</div><div class="line">	txObject.setSavepointAllowed(isNestedTransactionAllowed());</div><div class="line">	<span class="comment">// 如果当前线程已经记录数据库链接则使用原有链接</span></div><div class="line">	ConnectionHolder conHolder =</div><div class="line">			(ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());</div><div class="line">	<span class="comment">// false 表示非新创建连接</span></div><div class="line">	txObject.setConnectionHolder(conHolder, <span class="keyword">false</span>);</div><div class="line">	<span class="keyword">return</span> txObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>其中在同一个线程中，判断是否有重复的事务，是在 <code>TransactionSynchronizationManager.getResource(obtainDataSource())</code> 中完成的，关键判断逻辑是下面这个：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources =</div><div class="line">			<span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Transactional resources"</span>);</div><div class="line">			</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">doGetResource</span><span class="params">(Object actualKey)</span> </span>&#123;</div><div class="line">	Map&lt;Object, Object&gt; map = resources.get();</div><div class="line">	<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	Object value = map.get(actualKey);</div><div class="line">	<span class="comment">// Transparently remove ResourceHolder that was marked as void...</span></div><div class="line">	<span class="keyword">if</span> (value <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</div><div class="line">		map.remove(actualKey);</div><div class="line">		<span class="comment">// Remove entire ThreadLocal if empty...</span></div><div class="line">		<span class="keyword">if</span> (map.isEmpty()) &#123;</div><div class="line">			resources.remove();</div><div class="line">		&#125;</div><div class="line">		value = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>结论：<code>resources</code> 是一个 <code>ThreadLocal</code> 线程私有对象，每个线程独立存储，所以判断是否存在事务，判断的依据是当前线程、当前数据源(DataSource)中是否存在活跃的事务 - <code>map.get(actualKey)</code>。</strong></p>
<hr>
<h4 id="处理已经存在的事务"><a href="#处理已经存在的事务" class="headerlink" title="处理已经存在的事务"></a>处理已经存在的事务</h4><p><strong>根据前面说的，判断当前线程是否存在事务，判断依据为当前线程记录的连接不为空且连接中(connectionHolder)中的 <code>transactionActive</code> 属性不为空，如果当前线程存在事务，将根据不同的事务传播特性进行处理。具体代码逻辑如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (isExistingTransaction(transaction)) &#123;</div><div class="line">	<span class="comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></div><div class="line">	<span class="comment">// 当前线程存在事务，分情况进行处理</span></div><div class="line">	<span class="keyword">return</span> handleExistingTransaction(def, transaction, debugEnabled);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="PROPAGATION-NEVER"><a href="#PROPAGATION-NEVER" class="headerlink" title="PROPAGATION_NEVER"></a>PROPAGATION_NEVER</h5><p>在配置中配置设定为 <code>PROPAGATION_NEVER</code>，表示该方法需要在非事务的环境下运行，但处于事务处理的状态（可能是外部带事务的方法调用了非事务的方法），将会抛出异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</div><div class="line">				<span class="string">"Existing transaction found for transaction marked with propagation 'never'"</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h5 id="PROPAGATION-NOT-SUPPORTED"><a href="#PROPAGATION-NOT-SUPPORTED" class="headerlink" title="PROPAGATION_NOT_SUPPORTED"></a>PROPAGATION_NOT_SUPPORTED</h5><p>如果有事务存在，将事务挂起，而不是抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123;</div><div class="line">	Object suspendedResources = suspend(transaction);</div><div class="line">	<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</div><div class="line">	<span class="keyword">return</span> prepareTransactionStatus(</div><div class="line">			definition, <span class="keyword">null</span>, <span class="keyword">false</span>, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h5 id="事务挂起"><a href="#事务挂起" class="headerlink" title="事务挂起"></a>事务挂起</h5><p><strong>对于挂起操作，主要目的是记录原有事务的状态，以便于后续操作对事务的恢复：</strong></p>
<p>实际上，<code>suspend()</code> 方法调用的是事务管理器 <code>DataSourceTransactionManager</code> 中的 <code>doSuspend()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doSuspend</span><span class="params">(Object transaction)</span> </span>&#123;</div><div class="line">	DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</div><div class="line">	<span class="comment">//  将数据库连接设置为 null</span></div><div class="line">	txObject.setConnectionHolder(<span class="keyword">null</span>);</div><div class="line">	<span class="keyword">return</span> TransactionSynchronizationManager.unbindResource(obtainDataSource());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后调用的关键方法是 <code>TransactionSynchronizationManager#doUnbindResource</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">doUnbindResource</span><span class="params">(Object actualKey)</span> </span>&#123;</div><div class="line">	Map&lt;Object, Object&gt; map = resources.get();</div><div class="line">	<span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	Object value = map.remove(actualKey);</div><div class="line">	<span class="keyword">if</span> (map.isEmpty()) &#123;</div><div class="line">		resources.remove();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (value <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</div><div class="line">		value = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; logger.isTraceEnabled()) &#123;</div><div class="line">        Thread.currentThread().getName() + <span class="string">"]"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看了第七条参考资料中的文章，结合代码理解了<strong>事务挂起的操作：移除当前线程、数据源活动事务对象的一个过程</strong></p>
<p>那它是如何实现事务挂起的呢，答案是在 <code>doSuspend()</code> 方法中的 <code>txObject.setConnectionHolder(null)</code>，将 <code>connectionHolder</code> 设置为 <code>null</code>。</p>
<p><strong>一个 <code>connectionHolder</code> 表示一个数据库连接对象，如果它为 <code>null</code>，表示在下次需要使用时，得从缓存池中获取一个连接，新连接的自动提交是 <code>true</code>。</strong></p>
<hr>
<h5 id="PROPAGATION-REQUIRES-NEW"><a href="#PROPAGATION-REQUIRES-NEW" class="headerlink" title="PROPAGATION_REQUIRES_NEW"></a>PROPAGATION_REQUIRES_NEW</h5><p><strong>表示当前方法必须在它自己的事务里运行，一个新的事务将被启动，而如果有一个事务正在运行的话，则这个方法运行期间被挂起。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">SuspendedResourcesHolder suspendedResources = suspend(transaction);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">	DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">			definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">	<span class="comment">// 新事务的建立</span></div><div class="line">	doBegin(transaction, definition);</div><div class="line">	prepareSynchronization(status, definition);</div><div class="line">	<span class="keyword">return</span> status;</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> (RuntimeException | Error beginEx) &#123;</div><div class="line">	resumeAfterBeginException(transaction, suspendedResources, beginEx);</div><div class="line">	<span class="keyword">throw</span> beginEx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与前一个方法相同的是，在 <code>PROPAGATION_REQUIRES_NEW</code> 广播特性下，也会使用 <code>suspend</code> 方法将原事务挂起。<strong>方法 <code>doBegin()</code>，是事务开启的核心。</strong></p>
<hr>
<h5 id="PROPAGATION-NESTED"><a href="#PROPAGATION-NESTED" class="headerlink" title="PROPAGATION_NESTED"></a>PROPAGATION_NESTED</h5><p><strong>表示如果当前正有一个事务在运行中，则该方法应该运行在一个嵌套的事务中，被嵌套的事务可以独立于封装事务进行提交或者回滚，如果封装事务不存在，行为就像 <code>PROPAGATION_REQUIRES_NEW</code>。</strong></p>
<p>在代理处理上，有两个分支，与 <code>PROPAGATION_REQUIRES_NEW</code> 相似的不贴出来，讲下使用 <code>savepoint</code> 保存点的方式事务处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</div><div class="line">	<span class="comment">// 嵌入式事务的处理</span></div><div class="line">	<span class="keyword">if</span> (useSavepointForNestedTransaction()) &#123;</div><div class="line">		DefaultTransactionStatus status =</div><div class="line">				prepareTransactionStatus(definition, transaction, <span class="keyword">false</span>, <span class="keyword">false</span>, debugEnabled, <span class="keyword">null</span>);</div><div class="line">		<span class="comment">// 创建 savepoint</span></div><div class="line">		status.createAndHoldSavepoint();</div><div class="line">		<span class="keyword">return</span> status;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>学习过数据库的朋友应该清楚 <strong><code>savepoint</code>，可以利用保存点回滚部分事务，从而使事务处理更加灵活和精细</strong>。跟踪代码，发现创建保存点调用的方法是 <code>org.hsqldb.jdbc.JDBCConnection#setSavepoint(java.lang.String)</code>，感兴趣的可以往下继续深入学习~</p>
<hr>
<h4 id="事务创建"><a href="#事务创建" class="headerlink" title="事务创建"></a>事务创建</h4><p><strong>其实在前面方法中，都出现过这个方法 <code>doBegin()</code>，在这个方法中创建事务，顺便设置数据库的隔离级别、<code>timeout</code> 属性和设置 <code>connectionHolder</code>：</strong></p>
<blockquote>
<p>DataSourceTransactionManager#doBegin</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBegin</span><span class="params">(Object transaction, TransactionDefinition definition)</span> </span>&#123;</div><div class="line">	DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</div><div class="line">	Connection con = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span> (!txObject.hasConnectionHolder() ||</div><div class="line">			txObject.getConnectionHolder().isSynchronizedWithTransaction()) &#123;</div><div class="line">		Connection newCon = obtainDataSource().getConnection();</div><div class="line"></div><div class="line">		txObject.setConnectionHolder(<span class="keyword">new</span> ConnectionHolder(newCon), <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	txObject.getConnectionHolder().setSynchronizedWithTransaction(<span class="keyword">true</span>);</div><div class="line">	con = txObject.getConnectionHolder().getConnection();</div><div class="line">	<span class="comment">// 设置隔离级别</span></div><div class="line">	Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);</div><div class="line">	txObject.setPreviousIsolationLevel(previousIsolationLevel);</div><div class="line"></div><div class="line">	<span class="comment">// configured the connection pool to set it already).</span></div><div class="line">	<span class="comment">// 更改自动提交设置，由 spring 进行控制</span></div><div class="line">	<span class="keyword">if</span> (con.getAutoCommit()) &#123;</div><div class="line">		txObject.setMustRestoreAutoCommit(<span class="keyword">true</span>);</div><div class="line">		con.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 准备事务连接</span></div><div class="line">	prepareTransactionalConnection(con, definition);</div><div class="line">	<span class="comment">// 设置判断当前线程是否存在事务的依据</span></div><div class="line">	txObject.getConnectionHolder().setTransactionActive(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> timeout = determineTimeout(definition);</div><div class="line">	<span class="keyword">if</span> (timeout != TransactionDefinition.TIMEOUT_DEFAULT) &#123;</div><div class="line">		txObject.getConnectionHolder().setTimeoutInSeconds(timeout);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Bind the connection holder to the thread.</span></div><div class="line">	<span class="keyword">if</span> (txObject.isNewConnectionHolder()) &#123;</div><div class="line">		<span class="comment">// 将当前获取到的连接绑定到当前线程</span></div><div class="line">		TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结论：Spring 事务的开启，就是将数据库自动提交属性设置为 false</p>
</blockquote>
<hr>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>在声明式的事务处理中，主要有以下几个处理步骤：</p>
<ol>
<li><strong>获取事务的属性</strong>：<code>tas.getTransactionAttribute(method, targetClass)</code></li>
<li><strong>加载配置中配置的 <code>TransactionManager</code></strong>：<code>determineTransactionManager(txAttr);</code></li>
<li><strong>不同的事务处理方式使用不同的逻辑</strong>：关于声明式事务和编程式事务，可以查看这篇文章-<a href="https://juejin.im/post/5b010f27518825426539ba38" target="_blank" rel="noopener">Spring编程式和声明式事务实例讲解</a></li>
<li><strong>在目标方法执行前获取事务并收集事务信</strong>息：<code>createTransactionIfNecessary(tm, txAttr, joinpointIdentification)</code></li>
<li><strong>执行目标方法</strong>：<code>invocation.proceed()</code></li>
<li><strong>出现异常，尝试异常处理</strong>：<code>completeTransactionAfterThrowing(txInfo, ex);</code></li>
<li><strong>提交事务前的事务信息消除</strong>：<code>cleanupTransactionInfo(txInfo)</code></li>
<li><strong>提交事务</strong>：<code>commitTransactionAfterReturning(txInfo)</code></li>
</ol>
<hr>
<h4 id="事务回滚-amp-提交"><a href="#事务回滚-amp-提交" class="headerlink" title="事务回滚 &amp; 提交"></a>事务回滚 &amp; 提交</h4><p>这两步操作，主要调用了底层数据库连接的 <code>API</code>，所以没有细说。</p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇文章简单记录了如何使用 <code>Spring</code> 的事务，以及在代码中如何实现。</p>
<p><strong>在之前的使用场景中，只用到了默认配置的声明式事务 <code>@Transactional</code>，不了解其它属性设置的含义，也不知道在默认配置下，如果是同一个类中的方法自调用是不支持事务。</strong></p>
<p><strong>所以，经过这一次学习和总结，在下一次使用时，就能够知道不同属性设置能解决什么问题，例如修改广播特性 <code>PROPAGATION</code>，让事务支持方法自调用，还有设置事务超时时间 <code>timeout</code>、隔离级别等属性。</strong></p>
<hr>
<p><strong>由于个人技术有限，如果有理解不到位或者错误的地方，请留下评论，我会根据朋友们的建议进行修正</strong></p>
<p><a href="https://gitee.com/vip-augus/spring-analysis-note.git" target="_blank" rel="noopener">Gitee 地址 https://gitee.com/vip-augus/spring-analysis-note.git</a></p>
<p><a href="https://github.com/Vip-Augus/spring-analysis-note" target="_blank" rel="noopener">Github 地址 https://github.com/Vip-Augus/spring-analysis-note</a></p>
<hr>
<h1 id="传送门："><a href="#传送门：" class="headerlink" title="传送门："></a>传送门：</h1><ul>
<li><p><a href="https://vip-augus.github.io/2019/06/08/spring/2019-06-08-spring-analysis-note-env-prepared" target="_blank" rel="noopener">Spring 源码学习-环境准备</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/08/spring/2019-06-08-spring-analysis-note-1" target="_blank" rel="noopener">Spring 源码学习(一)容器的基础结构</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/14/spring/2019-06-14-spring-analysis-note-2" target="_blank" rel="noopener">Spring 源码学习(二)默认标签解析</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/16/spring/2019-06-16-spring-analysis-note-3" target="_blank" rel="noopener">Spring 源码学习(三)自定义标签</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/19/spring/2019-06-19-spring-analysis-note-4" target="_blank" rel="noopener">Spring 源码学习(四) bean 的加载</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/22/spring/2019-06-22-spring-analysis-note-5" target="_blank" rel="noopener">Spring 源码学习(五)循环依赖</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/22/spring/2019-06-22-spring-analysis-note-6" target="_blank" rel="noopener">Spring 源码学习(六)扩展功能 上篇</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/06/30/spring/2019-06-30-spring-analysis-note-7" target="_blank" rel="noopener">Spring 源码学习(七)扩展功能 下篇</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/07/17/spring/2019-07-17-spring-analysis-note-8" target="_blank" rel="noopener">Spring 源码学习(八) AOP 使用和实现原理</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/07/18/spring/2019-07-18-spring-analysis-note-9" target="_blank" rel="noopener">Spring 源码学习(九) Transaction 事务</a></p>
</li>
<li><p><a href="https://vip-augus.github.io/2019/07/21/spring/2019-07-21-spring-analysis-note-10" target="_blank" rel="noopener">Spring 源码学习(十) Spring mvc</a></p>
</li>
</ul>
<hr>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-master-spring-transactional-use/index.html#icomments" target="_blank" rel="noopener">透彻的掌握 Spring 中@transactional 的使用</a></li>
<li><a href="http://www.tianwj.com/2018/07/02/Spring%E2%80%94-Transactional%E6%B3%A8%E8%A7%A3/" target="_blank" rel="noopener">Spring—@Transactional注解</a></li>
<li><a href="https://blog.csdn.net/qh_java/article/details/51811533" target="_blank" rel="noopener">spring 中常用的两种事务配置方式以及事务的传播性、隔离级别</a></li>
<li><a href="https://my.oschina.net/zhangxufeng/blog/1943983" target="_blank" rel="noopener">Spring事务之切点解析详解</a></li>
<li><a href="https://xq0804200134.iteye.com/blog/1669190" target="_blank" rel="noopener">Spring中的Advisor，Advice，Pointcut</a></li>
<li><a href="https://juejin.im/post/5b010f27518825426539ba38" target="_blank" rel="noopener">Spring编程式和声明式事务实例讲解</a></li>
<li><a href="https://github.com/seaswalker/spring-analysis/blob/master/note/spring-transaction.md" target="_blank" rel="noopener">spring-transaction</a></li>
<li><a href="https://www.cnblogs.com/justfortaste/p/5054368.html" target="_blank" rel="noopener">savepoint原理</a></li>
<li>Spring 源码深度解析 / 郝佳编著. – 北京 : 人民邮电出版社</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/17/spring/2019-07-17-spring-analysis-note-8/" rel="next" title="Spring 源码学习(八) AOP 使用和实现原理">
                <i class="fa fa-chevron-left"></i> Spring 源码学习(八) AOP 使用和实现原理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/21/spring/2019-07-21-spring-analysis-note-10/" rel="prev" title="Spring 源码学习(十) Spring mvc">
                Spring 源码学习(十) Spring mvc <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjEzNi8xMjY3MQ=="></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://img.sevenyuan.cn/%E5%B0%8F%E7%86%8A%E7%8C%AB.jpeg"
               alt="JingQ" />
          <p class="site-author-name" itemprop="name">JingQ</p>
           
              <p class="site-description motion-element" itemprop="description">努力学习</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Vip-Augus" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/yjq41596" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/YeJingQi" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-anchor"></i>
                  
                    
                      Douban
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto://JingQBoom@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#使用例子"><span class="nav-number">1.</span> <span class="nav-text">使用例子</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注解属性-Transactional"><span class="nav-number">2.</span> <span class="nav-text">注解属性 @Transactional</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#事务的传播性-Propagation"><span class="nav-number">2.1.</span> <span class="nav-text">事务的传播性 Propagation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务的隔离性-Isolation"><span class="nav-number">2.2.</span> <span class="nav-text">事务的隔离性 Isolation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-中实现逻辑"><span class="nav-number">3.</span> <span class="nav-text">Spring 中实现逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解析"><span class="nav-number">3.1.</span> <span class="nav-text">解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注册-InfrastructureAdvisorAutoProxyCreator"><span class="nav-number">3.1.1.</span> <span class="nav-text">注册 InfrastructureAdvisorAutoProxyCreator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#判断目标方法是否适合-canApply"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">判断目标方法是否适合 canApply</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配标签-match"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">匹配标签 match</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">3.1.2.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行"><span class="nav-number">3.2.</span> <span class="nav-text">运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务增强器-TransactionInterceptor"><span class="nav-number">3.2.1.</span> <span class="nav-text">事务增强器 TransactionInterceptor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#事务管理器"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">事务管理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务开启"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">事务开启</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取-TransactionStatus"><span class="nav-number">3.2.1.3.</span> <span class="nav-text">获取 TransactionStatus</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#获取事务"><span class="nav-number">3.2.1.3.1.</span> <span class="nav-text">获取事务</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理已经存在的事务"><span class="nav-number">3.2.1.4.</span> <span class="nav-text">处理已经存在的事务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NEVER"><span class="nav-number">3.2.1.4.1.</span> <span class="nav-text">PROPAGATION_NEVER</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NOT-SUPPORTED"><span class="nav-number">3.2.1.4.2.</span> <span class="nav-text">PROPAGATION_NOT_SUPPORTED</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#事务挂起"><span class="nav-number">3.2.1.4.3.</span> <span class="nav-text">事务挂起</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-REQUIRES-NEW"><span class="nav-number">3.2.1.4.4.</span> <span class="nav-text">PROPAGATION_REQUIRES_NEW</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NESTED"><span class="nav-number">3.2.1.4.5.</span> <span class="nav-text">PROPAGATION_NESTED</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务创建"><span class="nav-number">3.2.1.5.</span> <span class="nav-text">事务创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-1"><span class="nav-number">3.2.1.6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务回滚-amp-提交"><span class="nav-number">3.2.1.7.</span> <span class="nav-text">事务回滚 &amp; 提交</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#传送门："><span class="nav-number">5.</span> <span class="nav-text">传送门：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-JingQ"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JingQ</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<a href="http://www.beian.miit.gov.cn">浙ICP备17002280号-1</a> 

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  





  

  

  

  

  

  

  
</body>
</html>
