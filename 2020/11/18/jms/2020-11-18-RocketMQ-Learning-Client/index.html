<!DOCTYPE html>

<html class lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="RocketMQ,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="å­¦ä¹ ä¸€ä¸‹ç«ç®­æ¶ˆæ¯ - æ¶ˆè´¹è€…çš„åŸç†å’Œä½¿ç”¨ğŸš€">
<meta name="keywords" content="RocketMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ Consumer æ·±å…¥å­¦ä¹ ">
<meta property="og:url" content="http://yoursite.com/2020/11/18/jms/2020-11-18-RocketMQ-Learning-Client/index.html">
<meta property="og:site_name" content="JingQ">
<meta property="og:description" content="å­¦ä¹ ä¸€ä¸‹ç«ç®­æ¶ˆæ¯ - æ¶ˆè´¹è€…çš„åŸç†å’Œä½¿ç”¨ğŸš€">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://img.sevenyuan.cn/TorontoSky_ZH-CN6932705886_1920x1080.jpg">
<meta property="og:image" content="http://img.sevenyuan.cn/rocket/broker/RocketMQ_Consumer_Consume_Type.png">
<meta property="og:image" content="http://img.sevenyuan.cn/rocketmq/RocketMQ-Part-Order-Message.png">
<meta property="og:image" content="http://img.sevenyuan.cn/rocket/RocketMQ_Idemponent_Consume_Design.png">
<meta property="og:image" content="http://img.sevenyuan.cn/rocket/broker/RocektMQ_Consumer_Acquire_Message.png">
<meta property="og:image" content="http://img.sevenyuan.cn/rocket/RocketMQ_Consumer_MessageQueue_Allocate.png">
<meta property="og:image" content="http://img.sevenyuan.cn/rocket/RocketMQ_Subscribe_Not_Equal.png">
<meta property="og:updated_time" content="2020-11-23T00:26:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ Consumer æ·±å…¥å­¦ä¹ ">
<meta name="twitter:description" content="å­¦ä¹ ä¸€ä¸‹ç«ç®­æ¶ˆæ¯ - æ¶ˆè´¹è€…çš„åŸç†å’Œä½¿ç”¨ğŸš€">
<meta name="twitter:image" content="http://img.sevenyuan.cn/TorontoSky_ZH-CN6932705886_1920x1080.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'JingQ'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/11/18/jms/2020-11-18-RocketMQ-Learning-Client/">





  <title>RocketMQ Consumer æ·±å…¥å­¦ä¹  | JingQ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JingQ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-javatech">
          <a href="http://www.justdojava.com/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            Java Geek Tech
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/18/jms/2020-11-18-RocketMQ-Learning-Client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JingQ">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://img.sevenyuan.cn/panda.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JingQ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RocketMQ Consumer æ·±å…¥å­¦ä¹ </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-18T21:00:00+08:00">
                2020-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index">
                    <span itemprop="name">RocketMQ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> æ¸¸è§ˆ
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>æ¬¡
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://img.sevenyuan.cn/TorontoSky_ZH-CN6932705886_1920x1080.jpg" alt></p>
<center><strong>å­¦ä¹ ä¸€ä¸‹ç«ç®­æ¶ˆæ¯ - æ¶ˆè´¹è€…çš„åŸç†å’Œä½¿ç”¨ğŸš€</strong></center>

<a id="more"></a>
<hr>
<h1 id="æ¶ˆè´¹æ¨¡å¼"><a href="#æ¶ˆè´¹æ¨¡å¼" class="headerlink" title="æ¶ˆè´¹æ¨¡å¼"></a>æ¶ˆè´¹æ¨¡å¼</h1><p>æ¶ˆæ¯æ¶ˆè´¹æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<p><img src="http://img.sevenyuan.cn/rocket/broker/RocketMQ_Consumer_Consume_Type.png" alt></p>
<h2 id="1ã€å¹¶å‘æ¶ˆè´¹"><a href="#1ã€å¹¶å‘æ¶ˆè´¹" class="headerlink" title="1ã€å¹¶å‘æ¶ˆè´¹"></a>1ã€å¹¶å‘æ¶ˆè´¹</h2><p>å¹¶å‘æ¶ˆè´¹æ˜¯é»˜è®¤çš„å¤„ç†æ–¹æ³•ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯ï¼Œå¯ä»¥å¹¶å‘æ¶ˆè´¹å¤šæ¡æ¶ˆæ¯ï¼Œæå‡æœºå™¨çš„èµ„æºåˆ©ç”¨ç‡ã€‚é»˜è®¤é…ç½®æ˜¯ 20 ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€å°æœºå™¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ç¬é—´å¯ä»¥æ¶ˆè´¹ 20 ä¸ªæ¶ˆæ¯ã€‚</p>
<p>å…¶ä¸­ <code>ConsumeMessageConcurrentlyService</code> çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConsumeMessageConcurrentlyService</span><span class="params">(DefaultMQPushConsumerImpl defaultMQPushConsumerImpl,</span></span></span><br><span class="line"><span class="function"><span class="params">        MessageListenerConcurrently messageListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMQPushConsumerImpl = defaultMQPushConsumerImpl;</span><br><span class="line">        <span class="keyword">this</span>.messageListener = messageListener;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.defaultMQPushConsumer = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer();</span><br><span class="line">        <span class="keyword">this</span>.consumerGroup = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup();</span><br><span class="line">        <span class="keyword">this</span>.consumeRequestQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.consumeExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeThreadMin(),</span><br><span class="line">            <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeThreadMax(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.consumeRequestQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ConsumeMessageThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ConsumeMessageScheduledThread_"</span>));</span><br><span class="line">        <span class="keyword">this</span>.cleanExpireMsgExecutors = Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"CleanExpireMsgScheduledThread_"</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2ã€é¡ºåºæ¶ˆè´¹"><a href="#2ã€é¡ºåºæ¶ˆè´¹" class="headerlink" title="2ã€é¡ºåºæ¶ˆè´¹"></a>2ã€é¡ºåºæ¶ˆè´¹</h2><p>æœ‰äº›ä¸šåŠ¡åœºæ™¯ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹éœ€è¦é¡ºåºæ€§ï¼Œä¾‹å¦‚è´­ç‰©æ—¶ï¼Œä¸‹è®¢å•ã€åº“å­˜æ ¡éªŒã€æ”¯ä»˜ã€å‘é€ç‰©æµï¼Œè™½ç„¶éƒ½å±äºã€Œè´­ç‰©ã€è¿™ä¸ªåœºæ™¯çš„å­ä»»åŠ¡ï¼Œä½†ä»–ä»¬ä¹‹é—´æ˜¯æœ‰é¡ºåºæ€§çš„ã€‚å¦‚æœå®ƒä»¬ä¸šåŠ¡å¤„ç†é€šè¿‡æ¶ˆæ¯è§£è€¦ï¼Œé‚£æ¶ˆæ¯æ¶ˆè´¹ä¹Ÿå¾—è¦æœ‰é¡ºåºæ€§ã€‚</p>
<p><code>RocketMQ</code> çš„åšæ³•å°±æ˜¯åˆ†åŒºæœ‰åºæ€§ï¼Œé¦–å…ˆéœ€è¦å‘é€è€…ï¼Œå°†æœ‰é¡ºåºçš„æ¶ˆæ¯å‘å¾€ <code>Topic</code> ä¸‹åŒä¸€ä¸ª <code>MessageQueue</code>ï¼Œç„¶åæ¶ˆè´¹è€…ï¼Œé¡ºåºåœ°ä¸€ä¸ªä¸€ä¸ªè¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆè´¹å¤±è´¥å°†ä¼šä¸€ç›´é‡è¯•ï¼Œå‰é¢æ¶ˆæ¯æ¶ˆè´¹å®Œæˆæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸šåŠ¡ä¸Šç¡®ä¿æ¶ˆæ¯å¤±è´¥æœºåˆ¶ï¼Œé¿å…æ¶ˆæ¯é˜»å¡ã€‚</p>
<p><img src="http://img.sevenyuan.cn/rocketmq/RocketMQ-Part-Order-Message.png" alt></p>
<hr>
<h1 id="å¹‚ç­‰æ¶ˆè´¹"><a href="#å¹‚ç­‰æ¶ˆè´¹" class="headerlink" title="å¹‚ç­‰æ¶ˆè´¹"></a>å¹‚ç­‰æ¶ˆè´¹</h1><p>åœ¨ <code>RocketMQ</code> çš„è®¾è®¡ä¸­ï¼Œæ˜¯ä¸ä¿è¯æ¶ˆæ¯çš„å¹‚ç­‰æ€§ï¼Œè¿™æ—¶å€™éœ€è¦ä¸šåŠ¡æ–¹è‡ªè¡Œä¿è¯ï¼Œé‡å¤æ¶ˆè´¹æ¶ˆè´¹ä¸ä¼šå¯¹æ•°æ®é€ æˆå½±å“ï¼Œä»æ•°å­¦æ„ä¹‰ä¸Šæ¥è¯´ï¼Œ<code>f(x) = f(f(x))</code>ï¼Œå¤šæ¬¡è®¡ç®—çš„ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ã€‚</p>
<p><code>RocketMQ</code> ä¿è¯å­˜å‚¨åœ¨ <code>Broker</code> çš„æ¶ˆæ¯æœ€å°‘æŠ•é€’ä¸€æ¬¡ï¼Œè¯¥ç‰¹æ€§ä¿è¯æ¶ˆæ¯ä¸€å®šä¼šè¢«æ¶ˆè´¹ï¼Œä½†ç”±äºç½‘ç»œæŠ–åŠ¨æˆ–è€…å…¶å®ƒåœºæ™¯ï¼Œå¯¼è‡´ä¸€æ¡æ¶ˆæ¯å¯èƒ½è¢«æ¶ˆè´¹å¤šæ¬¡ã€‚</p>
<p>åœ¨ç›¸åŒä¸šåŠ¡ç±»å‹çš„æ¶ˆæ¯ä¸­ï¼Œè¿™é‡Œéœ€è¦è€ƒè™‘ä¸¤ä¸ªåœºæ™¯</p>
<ul>
<li>å¹¶å‘æ¶ˆè´¹</li>
<li>æ¶ˆæ¯æ¶ˆè´¹è¶…æ—¶åé‡å¤æŠ•é€’</li>
</ul>
<p>ç¬¬ä¸€ä¸ªåœºæ™¯å¾ˆå¥½ç†è§£ï¼Œä¸€æ¡ç›¸åŒç±»å‹çš„æ¶ˆæ¯è¢«ä¸åŒçš„æ¶ˆè´¹è€…åŒæ—¶æ‹‰å–ï¼Œå¯èƒ½æ˜¯ä¸åŒå‘é€è€…åŒæ—¶å‘é€çš„ï¼Œä¾‹å¦‚å–œé—»ä¹è§çš„ <code>A B</code> è½¬è´¦é—®é¢˜ã€‚</p>
<p>ç¬¬äºŒä¸ªåœºæ™¯æ¯”è¾ƒéš¾é‡åˆ°ï¼Œé»˜è®¤æƒ…å†µï¼Œæ¶ˆæ¯å¤„ç†è¶…è¿‡ 15 åˆ†é’Ÿåï¼Œå°†ä¼šé‡æ–°æŠ•é€’æ¶ˆè´¹ï¼Œå¦‚æœåŸæ¥æœåŠ¡å™¨ <code>A</code> è¿˜åœ¨å¤„ç†ä¸­ï¼Œé‡æ–°æŠ•é€’çš„æ¶ˆæ¯è¢«æœåŠ¡å™¨ <code>B</code> æ‹‰å–äº†ï¼›å¦ä¸€ç§å°±æ˜¯æ‰‹åŠ¨é‡å‘æ¶ˆæ¯ï¼Œé€šè¿‡æ§åˆ¶å°å¯ä»¥é‡æ–°å‘é€ä¸€æ¨¡ä¸€æ ·çš„æ¶ˆæ¯ï¼Œ<code>MessageID</code> å’Œæ¶ˆæ¯ä½“è·Ÿä¹‹å‰ä¸€æ ·ï¼Œè¿™ä¸¤ç§æƒ…å†µä¸‹ä¹Ÿä¼šé€ æˆæ¶ˆæ¯é‡å¤æ¶ˆè´¹ã€‚</p>
<p>äºæ˜¯è®¾è®¡ä¸Šï¼Œè€ƒè™‘äº†ä½¿ç”¨ <code>Redis</code> åšåˆ†å¸ƒå¼é”ï¼Œé€šè¿‡ç«äº‰é”æ¥é¿å…åŒæ—¶æ¶ˆæ¯ï¼Œä»¥åŠç”¨ <code>Redis</code> æš‚å­˜æ¶ˆè´¹çŠ¶æ€ï¼Œè®¾è®¡å¦‚ä¸‹ï¼š</p>
<p><img src="http://img.sevenyuan.cn/rocket/RocketMQ_Idemponent_Consume_Design.png" alt></p>
<p><strong>æ³¨æ„ç‚¹ï¼š</strong></p>
<p>1ã€é”èµ„æº key çš„ç»„è£…è§„åˆ™ï¼ˆã€æ¶ˆè´¹ç»„ã€‘+ã€:ã€‘+ã€ä¸»é¢˜ topicã€‘+ã€:ã€‘+ã€messageId æˆ–è€… messageKeyã€‘</p>
<p>2ã€é”å¯¹åº”çš„çŠ¶æ€æµè½¬ï¼ˆProcessing or Successed)</p>
<p>3ã€é¿å…å¤„ç†è€—æ—¶è¶…è¿‡é” expire æ—¶é—´ï¼Œå¯¼è‡´å…¶å®ƒæœåŠ¡å™¨è®¢é˜…æ¶ˆæ¯å¹¶æˆåŠŸæ¶ˆè´¹ã€‚åŠ å…¥ä¸€ä¸ªå®šæ—¶çº¿ç¨‹æ± ï¼ŒæŠ¢åˆ°é”èµ„æºåï¼Œç»„è£…å®šæ—¶ä»»åŠ¡ï¼Œè¿›è¡Œã€ç»­æ—¶ã€‘</p>
<p>4ã€ä»»åŠ¡æˆåŠŸåï¼Œä¿®æ”¹çŠ¶æ€ä¸ºã€Successedã€‘ï¼Œå¤±æ•ˆæ—¶é—´è®¢ä¸º 1hï¼›å¤±è´¥æƒ…å†µï¼Œæ¸…ç†æ‰æ‰€æœ‰é”èµ„æºå’Œå®šæ—¶ä»»åŠ¡ï¼Œè¿”å›å¤±è´¥é‡è¯•ç­–ç•¥</p>
<p>5ã€æ ¹æ® Redis ä¸­ä¿å­˜çš„çŠ¶æ€ï¼Œè¿‡æ»¤é‡å¤çš„æ¶ˆæ¯</p>
<p>åœ¨æ¶ˆæ¯ <code>SDK</code> ä»£ç å®ç°ä¸Šï¼Œé€šè¿‡è£…é¥°å™¨æ¨¡å¼ï¼Œå°† <code>MessageConsumer</code> åŒ…è£…èµ·æ¥ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ä¸éœ€æ”¹åŠ¨å¤ªå¤§æƒ…å†µä¸‹ï¼ŒåŠ¨æ€å¢åŠ äº†å¹‚ç­‰æ¶ˆè´¹çš„åŠŸèƒ½ã€‚</p>
<hr>
<h1 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h1><p><img src="http://img.sevenyuan.cn/rocket/broker/RocektMQ_Consumer_Acquire_Message.png" alt></p>
<p>ä¸Šå›¾å±•ç¤ºäº†ï¼Œåœ¨ä¸€ä¸ª <code>pullRequestQueue</code>ï¼Œå¯èƒ½è·å–åˆ°å¤šä¸ªæ¶ˆæ¯ <code>MessageExt</code>ï¼Œç„¶åæ¯ä¸ªæ¶ˆæ¯å°†ä¼šè¿›å…¥æ¶ˆè´¹çº¿ç¨‹æ± ä¸­æ¶ˆè´¹ã€‚</p>
<p>Consumer ç«¯ä½¿ç”¨ <code>RebalanceImpl</code> æ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥æƒ³è¦ç†è§£æ‹‰å–æ¶ˆæ¯çš„æµç¨‹ï¼Œéœ€è¦é‡ç‚¹æŸ¥çœ‹å®ƒå®ç°ã€‚</p>
<p>Consumer å®ä¾‹å¯åŠ¨æ—¶ï¼Œåœ¨å·¥å‚ <code>MQClientInstance</code> ä¸­èƒ½å¤Ÿçœ‹åˆ° <code>new RebalanceService(this);</code>ï¼Œå¯åŠ¨äº†ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œæ¯éš” 20s è¿›è¡Œé‡å¹³è¡¡æ“ä½œ <code>mqClientFactory.doRebalance()</code></p>
<p>åŒæ ·æŒ‰ç…§æ¶ˆè´¹è€…çš„æ¶ˆè´¹æ¨¡å¼ï¼Œé‡å¹³è¡¡é€»è¾‘å¤„ç†åˆ†æˆä¸¤ä¸ª switch åˆ†æ”¯ï¼Œæ¥ä¸‹æ¥è®¨è®ºçš„æ˜¯ã€å¹¶å‘æ¶ˆè´¹ã€é€»è¾‘</p>
<h2 id="ä¸€ã€è·å–-MessageQueue-åˆ—è¡¨"><a href="#ä¸€ã€è·å–-MessageQueue-åˆ—è¡¨" class="headerlink" title="ä¸€ã€è·å– MessageQueue åˆ—è¡¨"></a>ä¸€ã€è·å– MessageQueue åˆ—è¡¨</h2><p>åœ¨ <code>RebalanceImpl</code> ç»´æŠ¤äº†ä¸€ä»½ <code>map</code> ç»“æ„çš„æœ¬åœ°ç¼“å­˜ <code>topicSubscribeInfoTable</code>ï¼Œä»¥ <code>topic</code> ç»´åº¦ä¿å­˜äº†å¯¹åº”çš„ <code>MesssageQueue</code> åˆ—è¡¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</span><br></pre></td></tr></table></figure>
<h2 id="äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨"><a href="#äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨" class="headerlink" title="äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨"></a>äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</span><br></pre></td></tr></table></figure>
<p>findConsumerIdList æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šTopic ä¸»é¢˜å’Œ ConsumerGroup æ¶ˆè´¹ç»„</p>
<p>åº•å±‚é€šè¿‡å‘é€ <code>RequestCode.GET_CONSUMER_LIST_BY_GROUP</code> è¯·æ±‚ç çš„ <code>RemotingCommand</code> åˆ° <code>Broker</code> æŸ¥è¯¢åœ¨çº¿æ¶ˆè´¹è€…åˆ—è¡¨ï¼Œæ‹¿åˆ°ç»“æœåååºåˆ—åŒ–</p>
<h2 id="ä¸‰ã€åˆ†é…-MessageQueue"><a href="#ä¸‰ã€åˆ†é…-MessageQueue" class="headerlink" title="ä¸‰ã€åˆ†é… MessageQueue"></a>ä¸‰ã€åˆ†é… MessageQueue</h2><p>æ ¹æ®åˆ†é…ç­–ç•¥ï¼Œç¡®å®šå½“å‰æ¶ˆè´¹è€…å®ä¾‹è¦ä»å“ªäº› MessageQueue è·å–æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MessageQueue&gt; allocateResult = </span><br><span class="line">    strategy.allocate(<span class="keyword">this</span>.consumerGroup,</span><br><span class="line">                      <span class="keyword">this</span>.mQClientFactory.getClientId(),</span><br><span class="line">                      mqAll,</span><br><span class="line">                      cidAll);</span><br></pre></td></tr></table></figure>
<p><img src="http://img.sevenyuan.cn/rocket/RocketMQ_Consumer_MessageQueue_Allocate.png" alt></p>
<p>é»˜è®¤åˆ†é…ç­–ç•¥æ˜¯å¹³å‡åˆ†é…ï¼Œå–å½“å‰ä¸‹æ ‡ <code>index</code>ï¼Œé˜Ÿåˆ—æ•°å–ä½™æœºå™¨æ•° <code>mod</code>ï¼Œç„¶åæŒ‰ç…§åŒºé—´ç»™å½“å‰åº”ç”¨åˆ†é…ã€‚</p>
<p>ä¾‹å¦‚æœ‰ 8 ä¸ªé˜Ÿåˆ—ï¼Œ2 å°åœ¨çº¿æœåŠ¡å™¨ï¼Œé‚£å¹³å‡æ¶ˆè´¹ 4 ä¸ªé˜Ÿåˆ—ï¼Œ4 4 åˆ†é…ï¼›3 å°æœåŠ¡å™¨çš„ï¼ŒæŒ‰ç…§ 3 3 2 åˆ†é…ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong></p>
<p>ç›®å‰é‡åˆ°å¾ˆå¤šä¸šåŠ¡å›¢é˜Ÿï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨äº†ç›¸åŒçš„åˆ†ç»„åï¼Œä½†æ˜¯è®¢é˜…ä¿¡æ¯ä¸ä¸€è‡´ï¼Œä¾‹å¦‚ä¹‹å‰å·²ç»éƒ¨ç½²äº†ä¸¤å°åº”ç”¨ï¼Œæœ¬æœŸå¼€å‘æ—¶ï¼Œæ–°å¢äº† Topic åï¼Œåé¦ˆæœ‰äº›æ¶ˆæ¯æ— æ³•æ¶ˆè´¹ï¼ŒæŸ¥çœ‹ Topic æ¶ˆè´¹æƒ…å†µè¡¨ç°å¦‚ä¸‹ï¼š</p>
<p><img src="http://img.sevenyuan.cn/rocket/RocketMQ_Subscribe_Not_Equal.png" alt></p>
<p>æ ¹æœ¬åŸå› å°±æ˜¯å‰é¢è¯´çš„ <code>MessageQueue</code> å¹³å‡åˆ†é…åï¼Œä¹‹å‰çš„åº”ç”¨æ²¡æœ‰è®¢é˜…æ–° <code>Topic</code>ï¼Œäºæ˜¯è¿™äº›æ¶ˆæ¯çŠ¶æ€ä¸€ç›´å¤„äº <code>Not Consumed Yet</code>ï¼Œ <strong>è§£å†³æ–¹æ³•å°±æ˜¯ç»Ÿä¸€è®¢é˜…ä¿¡æ¯æˆ–è€…æ›´æ¢ <code>ConsumerGroup</code> è¿›è¡Œæµ‹è¯•ã€‚</strong></p>
<h2 id="å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜-amp-æ„å»ºè¯·æ±‚åˆ—è¡¨"><a href="#å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜-amp-æ„å»ºè¯·æ±‚åˆ—è¡¨" class="headerlink" title="å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜ &amp; æ„å»ºè¯·æ±‚åˆ—è¡¨"></a>å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜ &amp; æ„å»ºè¯·æ±‚åˆ—è¡¨</h2><p>æ¥ä¸‹æ¥ï¼Œä¼šæ ¹æ®å‰é¢åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥æ„å»ºè·å–æ¶ˆæ¯çš„è¯·æ±‚ <code>pullRequest</code> é˜Ÿåˆ—</p>
<blockquote>
<p>org.apache.rocketmq.client.impl.consumer.RebalanceImpl#updateProcessQueueTableInRebalance</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class="keyword">this</span>.processQueueTable.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</span><br><span class="line">            MessageQueue mq = next.getKey();</span><br><span class="line">            ProcessQueue pq = next.getValue();</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;PullRequest&gt;();</span><br><span class="line">        <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.removeDirtyOffset(mq);</span><br><span class="line">                ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</span><br><span class="line">                <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</span><br><span class="line">                <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</span><br><span class="line">                    PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</span><br><span class="line">                    pullRequest.setConsumerGroup(consumerGroup);</span><br><span class="line">                    pullRequest.setNextOffset(nextOffset);</span><br><span class="line">                    pullRequest.setMessageQueue(mq);</span><br><span class="line">                    pullRequest.setProcessQueue(pq);</span><br><span class="line">                    pullRequestList.add(pullRequest);</span><br><span class="line">                    changed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) &#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>updateProcessQueueTableInRebalance</code> çš„ä½œç”¨ï¼šæ›´æ–°è®¢é˜…å…³ç³»</p>
<p>â‘ ã€æ¶ˆè´¹èŠ‚ç‚¹ä¸Šä¸‹çº¿<br>â‘¡ã€<code>Topic</code> çš„é˜Ÿåˆ—åˆ†åŒºå‚æ•°è°ƒæ•´</p>
<p>ä»¥ä¸Šä¸¤ç§è¡Œä¸ºï¼Œå°†ä¼šå½±å“åˆ°æ¶ˆæ¯è®¢é˜…çš„åˆ†é…ï¼Œæ‰€ä»¥éœ€è¦å®¢æˆ·ç«¯åœ¨æ¶ˆè´¹æ¶ˆæ¯å‰ï¼Œå…ˆç¡®å®šè‡ªå·±è¢«åˆ†é…åˆ°å“ªå‡ ä¸ª <code>MessageQueue</code>ï¼Œåœ¨æ„å»º <code>PullRequest</code> æ—¶ï¼Œå‚æ•°ä¸­å¸¦ä¸Šç›‘å¬çš„ <code>queueId</code>ã€‚</p>
<p>æœ€åï¼Œä¸ºè¿‡æ»¤åçš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆï¼ˆmqSetï¼‰ä¸­çš„æ¯ä¸ª <code>MessageQueue</code> åˆ›å»ºä¸€ä¸ª <code>ProcessQueue</code> å¯¹è±¡ï¼Œå¹¶å­˜å…¥ <code>RebalanceImpl</code> çš„ <code>processQueueTable</code> é˜Ÿåˆ—ä¸­ã€‚</p>
<p>æ¥ç€æ„å»º <code>PullRequest</code>ï¼Œå¹¶è°ƒç”¨ <code>dispatchPullRequest</code> æ–¹æ³•ï¼Œå°†æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚æ”¾å…¥åˆ° <code>pullRequestQueue</code> é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åé¢çš„ <code>PullMessageService</code> å–å‡ºæ¥è°ƒç”¨ã€‚</p>
<h2 id="äº”ã€åå°çº¿ç¨‹ä¸åœä»-Broker-æ‹‰å–æ¶ˆæ¯"><a href="#äº”ã€åå°çº¿ç¨‹ä¸åœä»-Broker-æ‹‰å–æ¶ˆæ¯" class="headerlink" title="äº”ã€åå°çº¿ç¨‹ä¸åœä» Broker æ‹‰å–æ¶ˆæ¯"></a>äº”ã€åå°çº¿ç¨‹ä¸åœä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯</h2><p>åå°çº¿ç¨‹æ˜¯ï¼š<strong>PullMessageService</strong></p>
<blockquote>
<p>org.apache.rocketmq.client.impl.consumer.PullMessageService#run</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</span><br><span class="line">            <span class="keyword">this</span>.pullMessage(pullRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"Pull Message Service Run Method exception"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pullRequestQueue</code> è¯·æ±‚é˜Ÿåˆ—ï¼Œå°±æ˜¯å‰é¢é‡å¹³è¡¡æœåŠ¡ï¼Œæ„å»ºå¥½æ”¾å…¥è¯¥é˜Ÿåˆ—ä¸­çš„ï¼Œç„¶ååœ¨ <code>PullMessageService</code> ä¸­çš„ <code>run</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>while</code> æ­»å¾ªç¯ï¼Œä¸åœçš„å» <code>Broker</code> è¯·æ±‚æ–°æ¶ˆæ¯</p>
<h2 id="å…­ã€æ¶ˆæ¯æ¶ˆè´¹"><a href="#å…­ã€æ¶ˆæ¯æ¶ˆè´¹" class="headerlink" title="å…­ã€æ¶ˆæ¯æ¶ˆè´¹"></a>å…­ã€æ¶ˆæ¯æ¶ˆè´¹</h2><p>åœ¨è·å–æ¶ˆæ¯æ—¶ï¼Œä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒæ¥å£ï¼Œå…·ä½“å…¥å£åœ¨ <code>MQConsumerInner</code>ï¼Œç„¶ååœ¨ <code>PullCallback</code> é‡Œè°ƒç”¨ <code>messageListener</code> è¿›è¡Œæ¶ˆè´¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚</p>
<p>åœ¨æ­£å¸¸æ¶ˆè´¹å®Œæˆåï¼Œå°† <code>pullRequest</code> é‡æ–°æ”¾å›æ‹‰å–æ¶ˆæ¯çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… <code>PullMessageService</code> çš„ä¸‹ä¸€æ¬¡è·å–ï¼Œæ‹‰å–æ–°æ¶ˆæ¯ã€‚</p>
<p>æ­£å¸¸æ¶ˆè´¹ï¼Œä¸šåŠ¡å¤„ç†æ²¡æœ‰å¼‚å¸¸çš„è¯ï¼Œå°†ä¼šè¿”å› <code>ConsumeReturnType.SUCCESS</code> è¡¨ç¤ºæˆåŠŸç¡®è®¤ï¼Œæ¶ˆè´¹ä½ç‚¹ä¹Ÿèƒ½ç»§ç»­å‰è¿›ã€‚</p>
<p><strong>æ¶ˆè´¹å¤±è´¥å°†ä¼šè§¦å‘è¡¥å¿æœºåˆ¶</strong></p>
<ul>
<li><code>ConsumeMessageConcurrentlyService</code> </li>
</ul>
<p>å¹¶å‘æ¨¡å¼ä¸‹ï¼Œå®ƒä¼šå°†æ¶ˆæ¯æŠ•é€’åˆ° <code>%retry</code> é˜Ÿåˆ—ï¼Œæ›´æ–°å½“å‰ä½ç‚¹ï¼Œè®©åé¢çš„æ¶ˆæ¯ç»§ç»­æ¶ˆè´¹ï¼Œå¦‚æœè¯¥æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œé»˜è®¤æœ€å¤šé‡è¯• 16 æ¬¡å°±ä¼šä¸¢åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚</p>
<ul>
<li><code>ConsumeMessageOrderlyService</code> </li>
</ul>
<p>é¡ºåºæ¨¡å¼éœ€è¦æ³¨æ„ä¸‹ï¼Œå‡ºç°å¤±è´¥å®ƒä¸ä¼šæŠ•é€’åˆ°é‡è¯•é˜Ÿåˆ—ï¼Œè€Œæ˜¯å°†ä¸€ç›´åœ¨æœ¬åœ°é‡è¯•ï¼Œç›´åˆ°æ¶ˆè´¹æˆåŠŸä¸ºæ­¢ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å‡ºç°æŸä¸ª <code>MessageQueue</code> æ¶ˆè´¹å¡ä½ï¼Œå¹¶ä¸”åé¢æ¶ˆæ¯éƒ½ä¸èƒ½æ¶ˆè´¹çš„åœºæ™¯ï¼Œæ³¨æ„æ•è·ä¸šåŠ¡å¤„ç†å¼‚å¸¸ã€‚</p>
<blockquote>
<p>org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#pullMessage</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</span><br><span class="line">    <span class="comment">// æ„å»ºå›è°ƒæ¥å£</span></span><br><span class="line">    PullCallback pullCallback = <span class="keyword">new</span> PullCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult, subscriptionData);</span><br><span class="line">                <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> FOUND:</span><br><span class="line">                        ...</span><br><span class="line">                        <span class="comment">// è¿™ä¸€æ­¥æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿›å…¥è®¾å®šçš„æ¶ˆè´¹é€»è¾‘ messageListener</span></span><br><span class="line">                        <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</span><br><span class="line">                            DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</span><br><span class="line">                            DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</span><br><span class="line">                                pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</span><br><span class="line">                            <span class="keyword">boolean</span> dispatchToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</span><br><span class="line">                            DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(pullResult.getMsgFoundList(), processQueue, pullRequest.getMessageQueue(), dispatchToConsume);</span><br><span class="line">                            <span class="comment">// æ˜¯å¦ç¨åæ‰æ¶ˆè´¹ï¼Œé‡æ–°æ‰”å›åˆ°è¯·æ±‚é˜Ÿåˆ—ä¸­</span></span><br><span class="line">                            <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">            ...</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä» Broker ç«¯è·å–æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(</span><br><span class="line">            pullRequest.getMessageQueue(),</span><br><span class="line">            subExpression,</span><br><span class="line">            subscriptionData.getExpressionType(),</span><br><span class="line">            subscriptionData.getSubVersion(),</span><br><span class="line">            pullRequest.getNextOffset(),</span><br><span class="line">            <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(),</span><br><span class="line">            sysFlag,</span><br><span class="line">            commitOffsetValue,</span><br><span class="line">            BROKER_SUSPEND_MAX_TIME_MILLIS,</span><br><span class="line">            CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,</span><br><span class="line">            CommunicationMode.ASYNC,</span><br><span class="line">            pullCallback</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">this</span>.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–æ¶ˆæ¯çš„è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†</p>
<p>â‘ ã€æ„å»ºæ¶ˆè´¹å›è°ƒå‡½æ•°<br>â‘¡ã€ä» <code>Broker</code> ç«¯è·å–æ–°æ¶ˆæ¯</p>
<p>å›è°ƒæ¥å£ä¸­ï¼Œè®¾å®šäº†å¯¹æ–°æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ï¼ŒåŒ…æ‹¬é¡ºåºæ¶ˆæ¯çš„ç‰¹æ®Šå¤„ç†ï¼Œè¿˜æœ‰æ˜¯å¦éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰æ¶ˆè´¹ï¼ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡æ–¹è®¾å®šçš„æ¶ˆè´¹é€»è¾‘åœ¨ <code>DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest)</code> æˆ– <code>DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest</code> ä¸­ã€‚</p>
<p>ç„¶åå°†å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæ”¾å…¥ <code>this.pullAPIWrapper.pullKernelImpl</code> æ–¹æ³•ä¸­ï¼Œæ¥æ”¶æ¶ˆæ¯åï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°æ¥å¤„ç†æ¶ˆæ¯ã€‚</p>
<p>åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼Œä»æ¶ˆæ¯è·å–åˆ°æ¶ˆæ¯æ¶ˆè´¹ï¼Œæ‰§è¡Œæœ¬åœ°ä¸šåŠ¡é€»è¾‘çš„åŸºæœ¬æµç¨‹å°±åŸºæœ¬äº†è§£æ¸…æ¥šï¼Œåé¢çš„çŠ¶æ€ç¡®è®¤ä»¥åŠä½ç‚¹ <code>offset</code> æ›´æ–°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å†å»è·Ÿè¸ªä¸€ä¸‹ã€‚</p>
<hr>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ¶ˆè´¹è€…çš„æ·±å…¥å­¦ä¹ åˆ†æˆä»¥ä¸‹å‡ éƒ¨åˆ†</p>
<ul>
<li>æ¶ˆè´¹æ¨¡å¼</li>
<li>å¹‚ç­‰æ¶ˆè´¹æ¦‚å¿µ</li>
<li>è´Ÿè½½å‡è¡¡</li>
</ul>
<p>è®°å½•äº†å¹¶å‘æ¨¡å¼å’Œå¹¿æ’­æ¨¡å¼çš„åŒºåˆ«ï¼Œä½¿ç”¨ä¸Šéœ€è¦æ³¨æ„çš„ç»†èŠ‚ã€‚</p>
<p>è·Ÿå¤§å®¶åˆ†äº«äº†ä¸€ä¸‹åœ¨åŸç”Ÿ RMQ ä¸æ”¯æŒå¹‚ç­‰æ¶ˆè´¹ï¼ŒåŒæ—¶ä¸éœ€è¦ä¸šåŠ¡æ–¹åšè¿‡å¤šæ”¹é€ çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å°è£… SDKï¼Œåœ¨é‡Œé¢å®ç°å¹‚ç­‰æ¶ˆè´¹çš„æ–¹æ¡ˆã€‚</p>
<p>æœ€åæ¢³ç†äº†ä¸€ä¸‹æ¶ˆè´¹è€…å¦‚ä½•é‡å¹³è¡¡ã€æ„å»ºæ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚æœ€åæ¶ˆè´¹æ¶ˆæ¯çš„ä»£ç è¿‡ç¨‹ã€‚</p>
<p>å…¶ä¸­è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ç‚¹è¿˜éœ€è¦å»äº†è§£ï¼Œä¾‹å¦‚é‡å¹³è¡¡ <code>doReblance</code> é˜¶æ®µï¼Œå‡ºç°æœåŠ¡å™¨ä¸Šä¸‹çº¿ï¼Œè¿˜å¤„äºæ¶ˆè´¹çš„ <code>MessageQueue</code> å¦‚ä½•å¤„ç†ï¼ˆçœ‹äº†ä¸€ä¸‹æœ‰åŠ é” lock æ“ä½œï¼Œé¿å…ä¸¤å°æœåŠ¡å™¨åŒæ—¶æ“ä½œåŒä¸€ä¸ªé˜Ÿåˆ—ï¼‰çš„ä»£ç å¦‚ä½•å®ç°ç­‰ç­‰</p>
<p>æœ€åï¼ŒMQ çš„å­¦ä¹ ä¹‹æ—…ï¼Œä»ç‚¹åˆ°é¢ï¼Œè¿˜éœ€è¦ç»§ç»­å­¦ä¹ ï¼Œä¹‹åå†è§ğŸ‘‹~</p>
<p>PSï¼šåˆ†ç±»æ€»ç»“æ’ç‰ˆå¯ä»¥å»çœ‹è¯­é›€ç¬”è®° <a href="https://www.yuque.com/books/share/2167ed0a-b9c9-4e1f-b648-1031b36cd144?# ã€ŠRocketMQã€‹" target="_blank" rel="noopener">https://www.yuque.com/books/share/2167ed0a-b9c9-4e1f-b648-1031b36cd144?# ã€ŠRocketMQã€‹</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RocketMQ/" rel="tag"># RocketMQ</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/10/31/jms/2020-11-01-RocketMQ-Learning-Broker/" rel="next" title="RocketMQ Broker æ·±å…¥å­¦ä¹ ">
                <i class="fa fa-chevron-left"></i> RocketMQ Broker æ·±å…¥å­¦ä¹ 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/05/16/daily/2021-05-interview-record/" rel="prev" title="ä¸ƒå¹´æ­æ¼‚ï¼Œå›æ·±åœ³">
                ä¸ƒå¹´æ­æ¼‚ï¼Œå›æ·±åœ³ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjEzNi8xMjY3MQ=="></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://img.sevenyuan.cn/panda.jpg" alt="JingQ">
          <p class="site-author-name" itemprop="name">JingQ</p>
           
              <p class="site-description motion-element" itemprop="description">åŠªåŠ›å­¦ä¹ </p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Vip-Augus" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/yjq41596" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/YeJingQi" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-anchor"></i>
                  
                    
                      Douban
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto://JingQBoom@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#æ¶ˆè´¹æ¨¡å¼"><span class="nav-number">1.</span> <span class="nav-text">æ¶ˆè´¹æ¨¡å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1ã€å¹¶å‘æ¶ˆè´¹"><span class="nav-number">1.1.</span> <span class="nav-text">1ã€å¹¶å‘æ¶ˆè´¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2ã€é¡ºåºæ¶ˆè´¹"><span class="nav-number">1.2.</span> <span class="nav-text">2ã€é¡ºåºæ¶ˆè´¹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å¹‚ç­‰æ¶ˆè´¹"><span class="nav-number">2.</span> <span class="nav-text">å¹‚ç­‰æ¶ˆè´¹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è´Ÿè½½å‡è¡¡"><span class="nav-number">3.</span> <span class="nav-text">è´Ÿè½½å‡è¡¡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸€ã€è·å–-MessageQueue-åˆ—è¡¨"><span class="nav-number">3.1.</span> <span class="nav-text">ä¸€ã€è·å– MessageQueue åˆ—è¡¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨"><span class="nav-number">3.2.</span> <span class="nav-text">äºŒã€è·å–åœ¨çº¿çš„æ¶ˆè´¹è€…ç»ˆç«¯åˆ—è¡¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸‰ã€åˆ†é…-MessageQueue"><span class="nav-number">3.3.</span> <span class="nav-text">ä¸‰ã€åˆ†é… MessageQueue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜-amp-æ„å»ºè¯·æ±‚åˆ—è¡¨"><span class="nav-number">3.4.</span> <span class="nav-text">å››ã€åˆ·æ–°æœ¬åœ°ç¼“å­˜ &amp; æ„å»ºè¯·æ±‚åˆ—è¡¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äº”ã€åå°çº¿ç¨‹ä¸åœä»-Broker-æ‹‰å–æ¶ˆæ¯"><span class="nav-number">3.5.</span> <span class="nav-text">äº”ã€åå°çº¿ç¨‹ä¸åœä» Broker æ‹‰å–æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…­ã€æ¶ˆæ¯æ¶ˆè´¹"><span class="nav-number">3.6.</span> <span class="nav-text">å…­ã€æ¶ˆæ¯æ¶ˆè´¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å°ç»“"><span class="nav-number">3.7.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-JingQ"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JingQ</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  æœ¬ç«™è®¿å®¢æ•°:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<a href="https://beian.miit.gov.cn">æµ™ICPå¤‡17002280å·-1</a> 

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> è®¿é—®äººæ•°
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> æ€»è®¿é—®é‡
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  





  

  

  

  

  

  

  
</body>
</html>
