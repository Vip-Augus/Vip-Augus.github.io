<!DOCTYPE html>

<html class="" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="MySQL," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="具体问题上周四下午执行数据库新增字段的时候，中途提示主键冲突，然后执行中断。12ALTER TABLE &apos;is_base&apos; ADD COLUMN &apos;cargo_name&apos; varchar(200);[Err] 1062 - Duplicate entry &apos;1-8186300008005054-4400173320-29228291&apos; for key &apos;IDX_IS_BASE&apos;. 然后根据错误原因">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="DRDS 新增字段报错 ERR 1062 - Duplicate entry">
<meta property="og:url" content="http://yoursite.com/2018/09/25/DRDS-新增字段报错-ERR-1062-Duplicate-entry/index.html">
<meta property="og:site_name" content="JingQ">
<meta property="og:description" content="具体问题上周四下午执行数据库新增字段的时候，中途提示主键冲突，然后执行中断。12ALTER TABLE &apos;is_base&apos; ADD COLUMN &apos;cargo_name&apos; varchar(200);[Err] 1062 - Duplicate entry &apos;1-8186300008005054-4400173320-29228291&apos; for key &apos;IDX_IS_BASE&apos;. 然后根据错误原因">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-06-02T04:02:16.282Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DRDS 新增字段报错 ERR 1062 - Duplicate entry">
<meta name="twitter:description" content="具体问题上周四下午执行数据库新增字段的时候，中途提示主键冲突，然后执行中断。12ALTER TABLE &apos;is_base&apos; ADD COLUMN &apos;cargo_name&apos; varchar(200);[Err] 1062 - Duplicate entry &apos;1-8186300008005054-4400173320-29228291&apos; for key &apos;IDX_IS_BASE&apos;. 然后根据错误原因">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'JingQ'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/25/DRDS-新增字段报错-ERR-1062-Duplicate-entry/"/>





  <title>DRDS 新增字段报错 ERR 1062 - Duplicate entry | JingQ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JingQ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-javatech">
          <a href="http://www.justdojava.com/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java Geek Tech
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/DRDS-新增字段报错-ERR-1062-Duplicate-entry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JingQ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img.sevenyuan.cn/%E5%B0%8F%E7%86%8A%E7%8C%AB.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JingQ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">DRDS 新增字段报错 ERR 1062 - Duplicate entry</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T13:02:10+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 游览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="具体问题"><a href="#具体问题" class="headerlink" title="具体问题"></a>具体问题</h2><p>上周四下午执行数据库新增字段的时候，中途提示主键冲突，然后执行中断。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">'is_base'</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">'cargo_name'</span> <span class="built_in">varchar</span>(<span class="number">200</span>);</div><div class="line">[Err] 1062 - Duplicate entry '1-8186300008005054-4400173320-29228291' for key 'IDX_IS_BASE'.</div></pre></td></tr></table></figure></p>
<p>然后根据错误原因<code>[ERR] 1062</code>去GOOGLE一下，发现也有小伙伴遇到同样的问题<a href="https://blog.csdn.net/mchdba/article/details/76695325" target="_blank" rel="noopener">RDS 在线DDL诡异报错ERROR 1062 (23000): Duplicate entry</a></p>
<h2 id="MYSQL文档提示"><a href="#MYSQL文档提示" class="headerlink" title="MYSQL文档提示"></a>MYSQL文档提示</h2><p><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-limitations.html" target="_blank" rel="noopener">Online DDL Limitations</a></p>
<blockquote>
<p>When running an online DDL operation, the thread that runs the ALTER TABLE statement applies an online log of DML operations that were run concurrently on the same table from other connection threads. When the DML operations are applied, it is possible to encounter a duplicate key entry error (ERROR 1062 (23000): Duplicate entry), even if the duplicate entry is only temporary and would be reverted by a later entry in the online log. This is similar to the idea of a foreign key constraint check in InnoDB in which constraints must hold during a transaction.</p>
<p>运行联机DDL操作时，运行ALTER TABLE语句的线程应用从其他连接线程在同一表上并发运行的DML操作的联机日志。<br>应用DML操作时，可能会遇到重复的密钥输入错误（ERROR 1062（23000）：重复条目），即使重复条目只是临时条目，也会被在线日志中的后续条目恢复。<br>这类似于InnoDB中的外键约束检查的想法，其中约束必须在事务期间保持。</p>
</blockquote>
<p>大概就是在高并发操作下，有大量的Alter操作，引起了DDL Limitations，然后结果是执行被中断了。所以根据文档，这应该算是MYSQL的预期行为。</p>
<hr>
<h2 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h2><h3 id="一、官方建议：Online-DDL-Performance-and-Concurrency"><a href="#一、官方建议：Online-DDL-Performance-and-Concurrency" class="headerlink" title="一、官方建议：Online DDL Performance and Concurrency"></a>一、官方建议：<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-concurrency.html" target="_blank" rel="noopener">Online DDL Performance and Concurrency</a></h3><blockquote>
<p>Applications that access the table are more responsive because queries and DML operations on the table can proceed while the DDL operation is in progress. Reduced locking and waiting for MySQL server resources leads to greater scalability, even for operations that are not involved in the DDL operation.<br>(减少锁）</p>
<p>In-place operations avoid the disk I/O and CPU cycles associated with the table-copy method, which minimizes overall load on the database. Minimizing load helps maintain good performance and high throughput during the DDL operation.<br>（避免磁盘I/O和CPU处理)</p>
</blockquote>
<h3 id="二、rds官方技术支持"><a href="#二、rds官方技术支持" class="headerlink" title="二、rds官方技术支持"></a>二、rds官方技术支持</h3><p><a href="https://help.aliyun.com/knowledge_detail/41734.html" target="_blank" rel="noopener">RDS for MySQL 如何使用 Percona Toolkit</a></p>
<p>注：</p>
<ul>
<li>pt-online-schema-change 和 pt-archiver 工具均须指定 –no-version-check 选项方能搭配 RDS MySQL 实例使用。</li>
<li>样例使用 Percona Toolkit 2.2.17 版本测试。</li>
<li>样例仅做为样例使用，不承担任何因此示范导致的问题责任。具体操作手册请参考 Percona Toolkit 的相关文档。</li>
</ul>
<p>从这两者来看，需要解决的工作量都不小，而且还有可能引起新的问题。</p>
<hr>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><strong>一开始以为3千万条记录的表数据量不算大，新增或者修改表结构应该还行，有张表是300w条记录，新增字段耗时92秒，也没有报错。</strong></p>
<p><strong>然后执行另一张表（2千万条记录）时报了这个错误</strong></p>
<p><strong>总结一下，由于是线上数据库，在没有切流之前，还是会有很多并发操作，对于大表（大概可以定在超过500万条记录）进行表结构修改时，需要等用户少或者停机发布时进行处理，避免高并发操作引起Alter操作错误。</strong></p>
<h3 id="PS：DRDS表修改大概耗时"><a href="#PS：DRDS表修改大概耗时" class="headerlink" title="PS：DRDS表修改大概耗时"></a>PS：DRDS表修改大概耗时</h3><ul>
<li>300w数据 ：92.210s</li>
<li>2000w数据：394.331s</li>
</ul>
<hr>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://blog.csdn.net/mchdba/article/details/76695325" target="_blank" rel="noopener">RDS 在线DDL诡异报错ERROR 1062 (23000): Duplicate entry</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-limitations.html" target="_blank" rel="noopener">Online DDL Limitations</a></li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/08/java/Java设计模式学习 - 模版方法模式&策略模式/" rel="next" title="Java设计模式学习 - 模版方法模式&策略模式">
                <i class="fa fa-chevron-left"></i> Java设计模式学习 - 模版方法模式&策略模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/11/软件设计师考试（中级）考点/" rel="prev" title="软件设计师考试（中级）考点">
                软件设计师考试（中级）考点 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjEzNi8xMjY3MQ=="></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://img.sevenyuan.cn/%E5%B0%8F%E7%86%8A%E7%8C%AB.jpeg"
               alt="JingQ" />
          <p class="site-author-name" itemprop="name">JingQ</p>
           
              <p class="site-description motion-element" itemprop="description">努力学习</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Vip-Augus" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/yjq41596" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/YeJingQi" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-anchor"></i>
                  
                    
                      Douban
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto://JingQBoom@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#具体问题"><span class="nav-number">1.</span> <span class="nav-text">具体问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MYSQL文档提示"><span class="nav-number">2.</span> <span class="nav-text">MYSQL文档提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化建议"><span class="nav-number">3.</span> <span class="nav-text">优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、官方建议：Online-DDL-Performance-and-Concurrency"><span class="nav-number">3.1.</span> <span class="nav-text">一、官方建议：Online DDL Performance and Concurrency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、rds官方技术支持"><span class="nav-number">3.2.</span> <span class="nav-text">二、rds官方技术支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">3.3.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PS：DRDS表修改大概耗时"><span class="nav-number">3.4.</span> <span class="nav-text">PS：DRDS表修改大概耗时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">3.5.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-JingQ"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JingQ</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<a href="http://www.beian.miit.gov.cn">浙ICP备17002280号-1</a> 

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  





  

  

  

  

  

  

  
</body>
</html>
